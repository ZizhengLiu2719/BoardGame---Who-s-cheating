<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game Room â€“ Who's Cheating?</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body.ghibli-game {
      background: linear-gradient(120deg, #f7ecd7 60%, #e2c391 100%);
      font-family: 'Segoe Print', 'Comic Sans MS', 'Arial', cursive;
      color: #5a4327;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .game-header {
      position: absolute;
      top: 24px;
      left: 32px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 18px;
    }
    .room-id-ghibli {
      font-size: 1.3rem;
      color: #7a5a2f;
      background: #fffbe7;
      border: 2.5px solid #e2c391;
      border-radius: 18px;
      padding: 12px 28px;
      box-shadow: 0 2px 8px 0 #e2c39133;
      font-family: 'Segoe Print', 'Comic Sans MS', 'Arial', cursive;
      letter-spacing: 2px;
      margin-bottom: 8px;
    }
    .room-name-ghibli {
      margin-top: 8px;
      font-size: 1.1rem;
      color: #a07c4f;
      background: #fffbe7;
      border: 2px solid #e2c391;
      border-radius: 14px;
      padding: 8px 22px;
      box-shadow: 0 2px 8px 0 #e2c39122;
    }
    .room-password-ghibli {
      margin-top: 8px;
      font-size: 1.1rem;
      color: #a07c4f;
      background: #fffbe7;
      border: 2px solid #e2c391;
      border-radius: 14px;
      padding: 8px 22px;
      box-shadow: 0 2px 8px 0 #e2c39122;
    }
    .player-count-box {
      background: #f7e7c6;
      border: 2px solid #bfa16a;
      border-radius: 14px;
      padding: 10px 22px;
      font-size: 1.1rem;
      color: #5a4327;
      box-shadow: 0 2px 8px 0 #e2c39122;
      margin-bottom: 8px;
    }
    .player-list {
      margin-top: 18px;
      background: #fffbe7;
      border: 2px solid #e2c391;
      border-radius: 12px;
      padding: 10px 18px;
      min-width: 180px;
      min-height: 60px;
      box-shadow: 0 2px 8px 0 #e2c39122;
    }
    .game-area-ghibli {
      margin: 120px auto 0 auto;
      max-width: 800px;
      background: #f7ecd7;
      border: 5px solid #bfa16a;
      border-radius: 32px;
      box-shadow: 0 8px 32px 0 rgba(90, 67, 39, 0.18), 0 0 0 18px #e2c39133 inset;
      padding: 40px 36px 32px 36px;
      min-height: 400px;
      text-align: center;
    }
    .ghibli-btn-ready {
      padding: 14px 38px;
      font-size: 1.15rem;
      font-family: inherit;
      background: linear-gradient(100deg, #e2c391 80%, #f7e7c6 100%);
      color: #5a4327;
      border: 3px solid #bfa16a;
      border-radius: 18px 40px 18px 40px / 40px 18px 40px 18px;
      box-shadow: 4px 8px 24px 0 rgba(90, 67, 39, 0.18), 0 2.5px 0 #e2c391 inset, 0 0 0 8px #e2c39122 inset;
      cursor: pointer;
      margin-right: 18px;
      transition: box-shadow 0.2s, transform 0.18s, background 0.2s, border 0.2s;
    }
    .ghibli-btn-ready:hover {
      background: linear-gradient(100deg, #f9eacb 80%, #e7cfa1 100%);
      box-shadow: 0 16px 48px 0 rgba(90, 67, 39, 0.28), 0 4px 0 #e2c391 inset, 0 0 0 12px #e2c39133 inset;
      transform: translateY(-3px) scale(1.03) rotate(-1deg);
      border-color: #a07c4f;
    }
    .ghibli-btn-unready {
      padding: 14px 38px;
      font-size: 1.15rem;
      font-family: inherit;
      background: linear-gradient(100deg, #f7e7c6 80%, #e2c391 100%);
      color: #a94442;
      border: 3px solid #e2c391;
      border-radius: 18px 40px 18px 40px / 40px 18px 40px 18px;
      box-shadow: 4px 8px 24px 0 rgba(90, 67, 39, 0.12), 0 2.5px 0 #e2c391 inset, 0 0 0 8px #e2c39111 inset;
      cursor: pointer;
      margin-right: 18px;
      transition: box-shadow 0.2s, transform 0.18s, background 0.2s, border 0.2s;
    }
    .ghibli-btn-unready:hover {
      background: linear-gradient(100deg, #fbead1 80%, #e2c391 100%);
      box-shadow: 0 16px 48px 0 rgba(90, 67, 39, 0.18), 0 4px 0 #e2c391 inset, 0 0 0 12px #e2c39122 inset;
      transform: translateY(-3px) scale(1.03) rotate(-1deg);
      border-color: #a07c4f;
    }
    .ghibli-btn-start {
      padding: 14px 38px;
      font-size: 1.18rem;
      font-family: inherit;
      background: linear-gradient(100deg, #bfa16a 80%, #e2c391 100%);
      color: #fffbe7;
      border: 3px solid #7a5a2f;
      border-radius: 40px 18px 40px 18px / 18px 40px 18px 40px;
      box-shadow: 4px 8px 32px 0 rgba(90, 67, 39, 0.22), 0 2.5px 0 #e2c391 inset, 0 0 0 8px #e2c39133 inset;
      cursor: pointer;
      transition: box-shadow 0.2s, transform 0.18s, background 0.2s, border 0.2s;
    }
    .ghibli-btn-start:disabled {
      background: #e2c391;
      color: #bfa16a;
      cursor: not-allowed;
      opacity: 0.7;
      border-color: #bfa16a;
    }
    .ghibli-btn-start:hover:enabled {
      background: linear-gradient(100deg, #e2c391 80%, #bfa16a 100%);
      box-shadow: 0 16px 48px 0 rgba(90, 67, 39, 0.28), 0 4px 0 #e2c391 inset, 0 0 0 12px #e2c39133 inset;
      transform: translateY(-3px) scale(1.03) rotate(-1deg);
      border-color: #7a5a2f;
    }
  </style>
</head>
<body class="ghibli-game">
  <div class="game-header">
    <div class="room-id-ghibli" id="roomIdBox">Room ID: <span id="roomId"></span></div>
    <div class="room-name-ghibli" id="roomNameBox" style="margin-top:8px; font-size:1.1rem; color:#a07c4f; background:#fffbe7; border:2px solid #e2c391; border-radius:14px; padding:8px 22px; box-shadow:0 2px 8px 0 #e2c39122;">Room Name: <span id="roomName"></span></div>
    <div class="room-password-ghibli" id="roomPasswordBox" style="margin-top:8px; font-size:1.1rem; color:#a07c4f; background:#fffbe7; border:2px solid #e2c391; border-radius:14px; padding:8px 22px; box-shadow:0 2px 8px 0 #e2c39122;">Room Password: <span id="roomPassword"></span></div>
    <div class="player-count-box" id="playerCountBox">Players: <span id="playerCount">1</span>/<span id="maxPlayers">6</span></div>
    <div class="player-list" id="playerList">
      <strong>Players in Room:</strong>
      <ul id="playerNames" style="margin: 8px 0 0 0; padding-left: 18px;"></ul>
    </div>
  </div>
  <div class="game-area-ghibli" id="gameArea">
    <h2>Welcome to the Game Room!</h2>
    <div id="hostControls" style="margin-top:32px;"></div>
    <p style="font-size:1.2rem; color:#7a5a2f;">Guys, are you ready for the cheating? lol</p>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Parse query params for roomId, maxPlayers, name, host, password, roomname
    function getQueryParams() {
      const params = {};
      window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(str,key,value) {
        params[key] = decodeURIComponent(value);
      });
      return params;
    }
    const params = getQueryParams();
    const roomId = params.roomId || '00000';
    const maxPlayers = params.maxPlayers || 6;
    const myName = params.name || '';
    const isHost = params.host === '1';
    let roomPassword = params.password || '';
    let roomName = params.roomname || '';
    document.getElementById('roomId').textContent = roomId;
    document.getElementById('maxPlayers').textContent = maxPlayers;
    document.getElementById('roomPassword').textContent = roomPassword ? roomPassword : '(hidden)';
    document.getElementById('roomName').textContent = roomName ? roomName : '(none)';
    let playerCount = 1;
    document.getElementById('playerCount').textContent = playerCount;

    // Socket.IO connection
    const socket = io();

    // Always join the room on page load, whether host or not
    let playerName = myName;
    if (!playerName) {
      playerName = prompt('Enter your name:');
    }
    // Only prompt for password if not present in URL
    if (!roomPassword) {
      roomPassword = prompt('Enter room password:');
      document.getElementById('roomPassword').textContent = roomPassword;
    }
    socket.emit('joinRoom', { roomId, password: roomPassword, playerName }, (res) => {
      if (!res.success) {
        alert(res.message || 'Failed to join room.');
        window.location.href = 'joining.html';
      }
    });

    // Helper: generate a color from a string (player name)
    function stringToColor(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
      }
      let color = '#';
      for (let i = 0; i < 3; i++) {
        color += ('00' + ((hash >> (i * 8)) & 0xFF).toString(16)).slice(-2);
      }
      return color;
    }

    // Ready/Unready and Start button logic
    let isReady = false;
    let allReady = false;
    let roomIsFull = false;
    let playerNamesCache = [];
    let readyStatesCache = {};
    function renderHostControls() {
      const hostControls = document.getElementById('hostControls');
      if (!isHost) {
        hostControls.innerHTML = '';
        return;
      }
      // Ready/Unready button
      const readyBtn = `<button id="readyBtn" class="${isReady ? 'ghibli-btn-unready' : 'ghibli-btn-ready'}">${isReady ? 'Unready' : 'Ready'}</button>`;
      // Start button (disabled if not all ready or not full)
      const startBtn = `<button id="startBtn" class="ghibli-btn-start" ${(!allReady || !roomIsFull) ? 'disabled' : ''}>Start</button>`;
      hostControls.innerHTML = readyBtn + startBtn;
      document.getElementById('readyBtn').onclick = function() {
        isReady = !isReady;
        socket.emit('setReadyState', { roomId, playerName: myName, isReady });
        renderHostControls();
      };
      document.getElementById('startBtn').onclick = function() {
        if (allReady && roomIsFull) {
          socket.emit('startGame', { roomId });
        }
      };
    }
    // For non-hosts, show only Ready/Unready button
    function renderPlayerControls() {
      const hostControls = document.getElementById('hostControls');
      if (isHost) return;
      const readyBtn = `<button id="readyBtn" class="${isReady ? 'ghibli-btn-unready' : 'ghibli-btn-ready'}">${isReady ? 'Unready' : 'Ready'}</button>`;
      hostControls.innerHTML = readyBtn;
      document.getElementById('readyBtn').onclick = function() {
        isReady = !isReady;
        socket.emit('setReadyState', { roomId, playerName: myName, isReady });
        renderPlayerControls();
      };
    }
    // Update player list and count, host always on top
    socket.on('playerListUpdate', (data) => {
      console.log('Received playerListUpdate:', data); // DEBUG LOG
      const players = data.players || [];
      playerCount = players.length;
      document.getElementById('playerCount').textContent = playerCount;
      // Update room name and password from server
      document.getElementById('roomName').textContent = data.roomName ? data.roomName : '(none)';
      document.getElementById('roomPassword').textContent = data.password ? data.password : '(hidden)';
      playerNamesCache = data.players || [];
      readyStatesCache = data.readyStates || {};
      roomIsFull = playerCount == maxPlayers;
      allReady = playerNamesCache.length == maxPlayers && playerNamesCache.every(n => readyStatesCache[n]);
      isReady = !!readyStatesCache[myName];
      // Render player list with ready state
      if (playerNamesCache.length === 0) {
        document.getElementById('playerNames').innerHTML = '<li style="color:#a07c4f;font-style:italic;">No players yet. Waiting for friends...</li>';
      } else {
        document.getElementById('playerNames').innerHTML = playerNamesCache.map((name, idx) => {
          const color = stringToColor(name);
          const ready = readyStatesCache[name];
          const readyCircle = `<span style=\"display:inline-block;width:14px;height:14px;border-radius:50%;background:${ready ? '#4caf50' : '#e74c3c'};margin-right:6px;border:2px solid #e2c391;box-shadow:0 1px 4px 0 #e2c39122;vertical-align:middle;\"></span>`;
          return `<li style=\"display:flex;align-items:center;margin-bottom:4px;\">${readyCircle}<span style=\"display:inline-block;width:18px;height:18px;border-radius:50%;background:${color};margin-right:10px;border:2px solid #e2c391;\"></span><span style=\"font-weight:${idx===0?'bold':'normal'};color:${idx===0?'#a07c4f':'#5a4327'}\">${name}${idx===0?' (Host)':''}${ready ? ' (Ready)' : ' (Unready)'}</span></li>`;
        }).join('');
      }
      // Render controls
      if (isHost) {
        renderHostControls();
      } else {
        renderPlayerControls();
      }
    });
    // Listen for startGame event
    socket.on('startGame', () => {
      // Redirect to start.html with roomId, name, and password
      const url = `start.html?roomId=${encodeURIComponent(roomId)}&name=${encodeURIComponent(myName)}&password=${encodeURIComponent(roomPassword)}${isHost ? '&createRoom=1' : ''}`;
      window.location.href = url;
    });
  </script>
</body>
</html>
