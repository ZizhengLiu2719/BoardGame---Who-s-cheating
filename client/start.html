<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Who's Cheating? ‚Äì Game Room</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Gochi+Hand&display=swap');
    body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a2e;
      color: #e2e2e2;
      min-height: 100vh;
      transition: background 0.5s ease;
    }
    body.day-mode {
      background: linear-gradient(135deg, #f8f4e3 0%, #e8d5b5 100%);
      color: #2c2c2c;
    }
    body.night-mode {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    }
    .container {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: flex-start;
      min-height: 100vh;
      width: 100vw;
      box-sizing: border-box;
      padding: 32px 0 32px 0;
      z-index: 1;
    }
    .left-panel, .right-panel {
      width: 320px;
      min-width: 260px;
      max-width: 400px;
      margin: 0 24px;
      display: flex;
      flex-direction: column;
      gap: 32px;
      background: rgba(255,251,231,0.92);
      border-radius: 24px;
      box-shadow: 0 4px 32px 0 #23202a33, 0 2px 0 #fffbe7 inset;
      border: 2.5px solid #bfa16a;
      padding: 18px 18px 18px 18px;
    }
    .center-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-width: 400px;
      max-width: 900px;
      z-index: 2;
    }
    .title-badge {
      font-size: 2.3rem;
      font-family: 'Gochi Hand', 'Caveat', 'Segoe Print', cursive;
      font-weight: bold;
      background: linear-gradient(120deg,#23202a 60%,#6b5a3a 100%);
      color: #e2c391;
      border-radius: 32px 22px 38px 22px/22px 38px 22px 38px;
      border: 3.5px solid #7bb0e6;
      box-shadow: 0 6px 24px 0 #23202a55, 0 2px 0 #fffbe7 inset;
      padding: 22px 48px 18px 48px;
      margin-bottom: 18px;
      text-align: center;
      letter-spacing: 2px;
      min-width: 200px;
      transition: all 0.3s;
      text-shadow: 0 2px 8px #23202a44;
    }
    body.day-mode .title-badge {
      background: linear-gradient(120deg,#fffbe7 60%,#ffe7b2 100%);
      color: #e2a84f;
      border: 3.5px solid #ffdca8;
    }
    .score-box, .love-hate-box {
      background: #fffbe7ee;
      border-radius: 18px;
      box-shadow: 0 2px 18px 0 #23202a22,0 2px 0 #fffbe7 inset;
      border: 2px solid #7bb0e6;
      padding: 18px 18px 14px 18px;
      font-size: 1.13rem;
      color: #7a5a2f;
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      font-family: 'Gochi Hand', 'Segoe Print', cursive;
    }
    .score-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .score-label {
      flex: 1;
      font-weight: bold;
      font-size: 1.13em;
      letter-spacing: 1px;
    }
    .score-controls {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .score-btn {
      width: 36px; height: 36px;
      border-radius: 12px;
      border: 2.5px solid #e2c391;
      background: linear-gradient(120deg,#ffe7b2 60%,#bfa16a 100%);
      color: #7a5a2f;
      font-size: 1.3em;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px #bfa16a33;
    }
    .score-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .score-value {
      width: 36px;
      text-align: center;
      font-size: 1.18em;
      font-weight: bold;
      color: #bfa16a;
      background: #fffbe7cc;
      border-radius: 8px;
      border: 1.5px solid #e2c391;
      box-shadow: 0 1px 4px #bfa16a22 inset;
    }
    .action-btn, .reset-btn, .vote-btn, .skill-btn {
      width: 100%;
      margin-top: 8px;
      padding: 12px 0;
      border-radius: 16px;
      border: 2.5px solid #e2c391;
      background: linear-gradient(120deg,#ffe7b2 60%,#bfa16a 100%);
      color: #7a5a2f;
      font-size: 1.18em;
      font-family: 'Gochi Hand', 'Segoe Print', cursive;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px #bfa16a33;
      letter-spacing: 1px;
      text-shadow: 0 1px 4px #fffbe7cc;
    }
    .action-btn:disabled, .reset-btn:disabled, .vote-btn:disabled, .skill-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .love-hate-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    .love-hate-label {
      flex: 1;
      font-weight: bold;
      font-size: 1.13em;
    }
    .love-hate-value {
      width: 36px;
      text-align: center;
      font-size: 1.18em;
      font-weight: bold;
      color: #e26a6a;
      background: #fffbe7cc;
      border-radius: 8px;
      border: 1.5px solid #e2c391;
      box-shadow: 0 1px 4px #e2c39122 inset;
    }
    .hate-value {
      color: #7a5a2f;
    }
    .circle-table-container {
      position: relative;
      width: 520px;
      height: 520px;
      margin: 0 auto 24px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }
    .circle-table {
      width: 420px;
      height: 420px;
      border-radius: 50%;
      background: radial-gradient(circle at 60% 40%, #6b5a3a 55%, #2d1c0b 100%);
      border: 10px solid #bfa16a;
      box-shadow: 0 16px 64px 0 #23202a, 0 0 0 32px #23202a33 inset, 0 0 0 12px #7bb0e633 inset;
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      z-index: 1;
    }
    body.day-mode .circle-table {
      background: radial-gradient(circle at 60% 40%, #fffbe7 60%, #ffe7b2 100%);
      box-shadow: 0 20px 80px 0 #ffdca888, 0 0 0 32px #fffbe7cc inset, 0 0 0 12px #ffe7b2cc inset;
    }
    .role-cards-circle {
      position: absolute;
      left: 50%; top: 50%;
      width: 520px; height: 520px;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 2;
    }
    .role-card {
      position: absolute;
      width: 90px; height: 135px;
      border-radius: 12px;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
      border: 2px solid #e2c391;
      background: #fffbe7;
      object-fit: cover;
      transition: all 0.3s ease;
    }
    .role-card.me {
      border: 3px solid #7a5a2f;
      box-shadow: 0 0 0 4px rgba(191, 161, 106, 0.3);
    }
    .role-card.me.night-mode {
      border-color: #7bb0e6;
      box-shadow: 0 0 0 4px rgba(123, 176, 230, 0.3);
    }
    .player-name-label {
      position: absolute;
      padding: 6px 12px;
      background: rgba(40, 30, 20, 0.85);
      color: #e2c391;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      white-space: nowrap;
      pointer-events: none;
      transition: all 0.3s ease;
    }
    .player-name-label.night-mode {
      background: rgba(26, 26, 46, 0.85);
      color: #7bb0e6;
    }
    .skill-btn {
      width: auto;
      min-width: 120px;
      margin: 0 8px;
      padding: 10px 18px;
      border-radius: 14px;
      border: 2.5px solid #e2c391;
      background: linear-gradient(120deg,#ffe7b2 60%,#bfa16a 100%);
      color: #7a5a2f;
      font-size: 1.13em;
      font-family: 'Gochi Hand', 'Segoe Print', cursive;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px #bfa16a33;
      letter-spacing: 1px;
      text-shadow: 0 1px 4px #fffbe7cc;
    }
    .skill-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    @media (max-width: 1200px) {
      .container { flex-direction: column; align-items: center; }
      .left-panel, .right-panel { width: 90vw; max-width: 98vw; margin: 0 0 24px 0; }
      .center-panel { min-width: 320px; }
      .circle-table-container, .role-cards-circle { width: 98vw; height: 98vw; min-width: 200px; min-height: 200px; }
      .circle-table { width: 60vw; height: 60vw; min-width: 200px; min-height: 200px; }
    }
    .game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    .table {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 480px;
      height: 480px;
      background: rgba(255, 251, 231, 0.95);
      border-radius: 50%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      border: 3px solid #e2c391;
      transition: all 0.3s ease;
    }
    .table.night-mode {
      background: rgba(40, 40, 60, 0.95);
      border-color: #7bb0e6;
      box-shadow: 0 8px 32px rgba(123, 176, 230, 0.2);
    }
    .host-controls {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 100;
    }
    .host-button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 251, 231, 0.9);
      color: #2c2c2c;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .host-button:hover {
      background: #e2c391;
      transform: translateY(-2px);
    }
    .host-button.night-mode {
      background: rgba(40, 40, 60, 0.9);
      color: #e2e2e2;
    }
    .count-controls {
      position: fixed;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 15px;
      z-index: 100;
    }
    .count-button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background: rgba(255, 251, 231, 0.9);
      color: #2c2c2c;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .count-button:hover {
      background: #e2c391;
      transform: translateY(-2px);
    }
    .count-button.night-mode {
      background: rgba(40, 40, 60, 0.9);
      color: #e2e2e2;
    }
    .ui-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      background: rgba(255, 251, 231, 0.95);
      color: #2c2c2c;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      font-weight: 500;
      z-index: 1000;
      transition: all 0.3s ease;
    }
    .ui-message.night-mode {
      background: rgba(40, 40, 60, 0.95);
      color: #e2e2e2;
    }
  </style>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="container">
    <!-- Left Panel: Scores and Actions -->
    <div class="left-panel">
      <div class="title-badge" id="gameTitleBadge">Who's Cheating?</div>
      <div class="score-box">
        <div class="score-row">
          <span class="score-label">Party Count</span>
          <span class="score-controls">
            <button class="score-btn host-only" id="partyMinusBtn">-1</button>
            <span class="score-value" id="partyCount">0</span>
            <button class="score-btn host-only" id="partyPlusBtn">+1</button>
          </span>
        </div>
        <div class="score-row">
          <span class="score-label">Scandal Score</span>
          <span class="score-controls">
            <button class="score-btn host-only" id="scandalMinusBtn">-1</button>
            <span class="score-value" id="scandalScore">0</span>
            <button class="score-btn host-only" id="scandalPlusBtn">+1</button>
          </span>
        </div>
        <div class="score-row">
          <span class="score-label">Close-Knot Score</span>
          <span class="score-controls">
            <button class="score-btn host-only" id="closeKnotMinusBtn">-1</button>
            <span class="score-value" id="closeKnotScore">0</span>
            <button class="score-btn host-only" id="closeKnotPlusBtn">+1</button>
          </span>
        </div>
        <div class="score-row">
          <span class="score-label">Vote Count</span>
          <span class="score-controls">
            <button class="score-btn host-only" id="voteMinusBtn">-1</button>
            <span class="score-value" id="voteCount">0</span>
            <button class="score-btn host-only" id="votePlusBtn">+1</button>
          </span>
        </div>
      </div>
      <div class="love-hate-box">
        <div class="love-hate-row">
          <span class="love-hate-label">Love Count</span>
          <span class="love-hate-value" id="loveCount">0</span>
        </div>
        <div class="love-hate-row">
          <span class="love-hate-label">Hate Count</span>
          <span class="love-hate-value hate-value" id="hateCount">0</span>
        </div>
        <button class="action-btn host-only" id="takeActionBtn">Take Action</button>
        <button class="reset-btn host-only" id="resetLoveHateBtn">Reset Count</button>
        <button class="reset-btn host-only" id="resetVoteBtn">Reset Vote</button>
      </div>
    </div>
    <!-- Center Panel: Table and Cards -->
    <div class="center-panel">
      <div class="circle-table-container">
        <div class="circle-table"></div>
        <div class="role-cards-circle" id="roleCardsCircle"></div>
      </div>
      <div id="skillButtonContainer" style="margin: 24px 0 0 0; display: flex; gap: 12px;"></div>
      <div style="margin: 24px 0 0 0; display: flex; gap: 12px;">
        <button class="vote-btn" id="voteYesBtn" style="background:#ffe7b2;color:#e26a6a;">‚ù§Ô∏è Love</button>
        <button class="vote-btn" id="voteNoBtn" style="background:#ffe7b2;color:#7a5a2f;">üíî Hate</button>
        <button class="vote-btn" id="voteSubmitBtn" style="background:#b2d7ff;color:#2a4a7a;">Vote</button>
      </div>
    </div>
    <!-- Right Panel: How to Play -->
    <div class="right-panel">
      <div class="score-box" style="min-height: 320px; max-height: 70vh; overflow-y: auto;">
        <div style="font-size:1.13rem;font-weight:bold;margin-bottom:8px;color:#7bb0e6;letter-spacing:1px;">How to Play</div>
        <div style="font-size:1.05rem;">
          <b>Game Overview</b><br>
          ‚Ä¢ 6‚Äì9 players: Cheaters vs. Keepers<br>
          ‚Ä¢ Cheaters: 2‚Äì3 players, Keepers: 4‚Äì6 players<br>
          ‚Ä¢ Each player gets a unique role with special abilities<br>
          ‚Ä¢ Game ends when all Cheaters are caught or when Cheaters win<br>
          <br>
          <b>Game Flow</b><br>
          ‚Ä¢ Each round, players take turns picking Helpers<br>
          ‚Ä¢ Helpers can be Love (positive) or Hate (negative)<br>
          ‚Ä¢ Host and helpers can play Love/Hate cards when allowed<br>
          ‚Ä¢ Special skills can be used at certain times<br>
          ‚Ä¢ Use the UI to track scores and actions<br>
        </div>
      </div>
      <button class="reset-btn host-only" id="restartBtn" style="margin-top:24px;">Restart the Game</button>
      <button id="toggleStageBtn" style="position:absolute;top:32px;right:32px;padding:12px 28px;font-size:1.1em;border-radius:16px;border:2px solid #e2c391;background:#ffe7b2;color:#7a5a2f;font-weight:bold;box-shadow:0 2px 8px 0 #e2c39133;cursor:pointer;z-index:10;">üåô Switch to Day</button>
    </div>
  </div>
  <div id="gameStateBox" style="display:none;"></div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let tempLoveCount = 0;
    let tempHateCount = 0;
    let isSkillPhase = false;
    let currentPlayer = null;
    let gameState = null;

    // Get DOM elements
    const loveBtn = document.getElementById('voteYesBtn');
    const hateBtn = document.getElementById('voteNoBtn');
    const loveCount = document.getElementById('loveCount');
    const hateCount = document.getElementById('hateCount');
    const windSkillBtn = document.getElementById('windSkillBtn');
    const kennediSkillBtn = document.getElementById('kennediSkillBtn');
    const roleCardsCircle = document.getElementById('roleCardsCircle');
    const uiMessageBox = document.createElement('div');
    uiMessageBox.style.cssText = `
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 1.2em;
      z-index: 1000;
      display: none;
    `;
    document.body.appendChild(uiMessageBox);

    // Function to position cards in a circle
    function positionCardsInCircle(players) {
      roleCardsCircle.innerHTML = '';
      const radius = 200;
      const centerX = 240;
      const centerY = 240;
      players.forEach((player, index) => {
        const angle = (index * 2 * Math.PI) / players.length;
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);
        const cardContainer = document.createElement('div');
        cardContainer.style.cssText = `position: absolute; left: ${x}px; top: ${y}px; transform: translate(-50%, -50%); width: 80px; height: 120px; transition: all 0.3s ease;`;
        const roleCard = document.createElement('img');
        roleCard.className = 'role-card';
        if (player.id === socket.id) {
          roleCard.classList.add('me');
          roleCard.src = `/imgs/${player.role ? player.role.toLowerCase() : 'backSide'}.png`;
        } else {
          // Show backSide for other players
          roleCard.src = '/imgs/backSide.png';
        }
        const nameLabel = document.createElement('div');
        nameLabel.className = 'player-name-label';
        nameLabel.textContent = player.name;
        cardContainer.appendChild(roleCard);
        cardContainer.appendChild(nameLabel);
        roleCardsCircle.appendChild(cardContainer);
      });
    }

    // Show UI message
    function showUIMessage(text, duration) {
      uiMessageBox.textContent = text;
      uiMessageBox.style.display = 'block';
      if (duration) {
        setTimeout(() => {
          uiMessageBox.style.display = 'none';
          if (text.includes('Wind and Kennedi')) {
            isSkillPhase = false;
            if (windSkillBtn) windSkillBtn.disabled = true;
            if (kennediSkillBtn) kennediSkillBtn.disabled = true;
          }
        }, duration);
      }
    }

    // --- UI Message-Driven Button States ---
    let loveHateWindow = false;
    let voteWindow = false;
    let windKennediSkillWindow = false;

    function setLoveHateWindow(enabled) {
      loveHateWindow = enabled;
      loveBtn.disabled = !enabled;
      hateBtn.disabled = !enabled;
    }
    function setVoteWindow(enabled) {
      voteWindow = enabled;
      document.getElementById('voteYesBtn').disabled = !enabled;
      document.getElementById('voteNoBtn').disabled = !enabled;
      document.getElementById('voteSubmitBtn').disabled = !enabled;
    }
    function setWindKennediSkillWindow(enabled) {
      windKennediSkillWindow = enabled;
      renderSkillButtons();
    }

    // --- Listen for UI Messages to Control Button States ---
    socket.on('uiMessage', (message) => {
      if (message) {
        showUIMessage(message.text, 10000);
        if (message.text.includes('Host and helpers can do their love or hate action now!')) {
          setLoveHateWindow(true);
          setTimeout(() => setLoveHateWindow(false), 10000);
        }
        if (message.text.includes('Wind and Kennedi are allowed to use their skills right now!')) {
          setWindKennediSkillWindow(true);
          setTimeout(() => setWindKennediSkillWindow(false), 10000);
        }
        if (message.text.includes('Every player can vote now!')) {
          setVoteWindow(true);
          setTimeout(() => setVoteWindow(false), 10000);
        }
      }
    });

    // --- Skill Button Logic (polished) ---
    function renderSkillButtons() {
      const skillButtonContainer = document.getElementById('skillButtonContainer');
      skillButtonContainer.innerHTML = '';
      if (!gameState || !gameState.players) return;
      const me = gameState.players.find(p => p.id === socket.id);
      if (!me || !me.role) return;
      const usedSkills = (gameState.usedActions && gameState.usedActions.skills && gameState.usedActions.skills[me.name]) || {};
      let enabled = false;
      if (me.role === 'Wind') {
        enabled = windKennediSkillWindow && !usedSkills['mislead'];
      } else if (me.role === 'Kennedi') {
        enabled = windKennediSkillWindow && !usedSkills['protectingparty'];
      } else if (me.role === 'Jack') {
        enabled = !gameState.isDay && !usedSkills['molest'];
      } else if (me.role === 'Michael') {
        enabled = !usedSkills['findabby'];
      } else if (me.role === 'Ker') {
        enabled = !usedSkills['thechosenone'];
      }
      skillButtonContainer.appendChild(createSkillButton(me.role, usedSkills[getSkillButtonLabel(me.role).toLowerCase().replace(/ /g, '')], enabled, () => {
        if (me.role === 'Ker') {
          showKerPopup();
        } else {
          socket.emit('useSkill', { skill: getSkillButtonLabel(me.role).toLowerCase().replace(/ /g, '') });
        }
      }));
    }

    // --- Love/Hate/Vote Button One-Time Use Logic ---
    loveBtn.addEventListener('click', () => {
      if (!loveBtn.disabled && loveHateWindow) {
        tempLoveCount++;
        loveCount.textContent = tempLoveCount;
        loveBtn.disabled = true;
        hateBtn.disabled = true;
        socket.emit('loveHateAction', { type: 'love', count: tempLoveCount });
      }
    });
    hateBtn.addEventListener('click', () => {
      if (!hateBtn.disabled && loveHateWindow) {
        tempHateCount++;
        hateCount.textContent = tempHateCount;
        loveBtn.disabled = true;
        hateBtn.disabled = true;
        socket.emit('loveHateAction', { type: 'hate', count: tempHateCount });
      }
    });
    document.getElementById('voteSubmitBtn').addEventListener('click', () => {
      if (!voteWindow) return;
      document.getElementById('voteYesBtn').disabled = true;
      document.getElementById('voteNoBtn').disabled = true;
      document.getElementById('voteSubmitBtn').disabled = true;
      // Emit vote action to server
      socket.emit('gameAction', { roomId, action: 'vote', playerName: myName });
    });

    // Handle skill buttons
    if (windSkillBtn) {
      windSkillBtn.addEventListener('click', () => {
        if (!windSkillBtn.disabled && isSkillPhase) {
          socket.emit('useSkill', { skill: 'mislead' });
          windSkillBtn.disabled = true;
        }
      });
    }

    if (kennediSkillBtn) {
      kennediSkillBtn.addEventListener('click', () => {
        if (!kennediSkillBtn.disabled && isSkillPhase) {
          socket.emit('useSkill', { skill: 'protectingParty' });
          kennediSkillBtn.disabled = true;
        }
      });
    }

    // Socket event listeners
    socket.on('updateLoveHateCount', ({ love, hate }) => {
      loveCount.textContent = love;
      hateCount.textContent = hate;
      tempLoveCount = love;
      tempHateCount = hate;
    });

    socket.on('enableLoveHate', () => {
      loveBtn.disabled = false;
      hateBtn.disabled = false;
    });

    socket.on('disableLoveHate', () => {
      loveBtn.disabled = true;
      hateBtn.disabled = true;
    });

    // Debug: Log all socket events
    socket.onAny((event, ...args) => {
      console.log('[Socket Event]', event, ...args);
    });

    // Handle game state updates
    socket.on('gameStateUpdate', (newGameState) => {
      console.log('[gameStateUpdate]', newGameState);
      gameState = newGameState;
      
      // Update score displays
      if (gameState.partyCount !== undefined) {
        document.getElementById('partyCount').textContent = gameState.partyCount;
      }
      if (gameState.scandalScore !== undefined) {
        document.getElementById('scandalScore').textContent = gameState.scandalScore;
      }
      if (gameState.closeKnotScore !== undefined) {
        document.getElementById('closeKnotScore').textContent = gameState.closeKnotScore;
      }
      if (gameState.voteCount !== undefined) {
        document.getElementById('voteCount').textContent = gameState.voteCount;
      }
      if (gameState.loveCount !== undefined) {
        loveCount.textContent = gameState.loveCount;
      }
      if (gameState.hateCount !== undefined) {
        hateCount.textContent = gameState.hateCount;
      }
      
      // Update day/night mode
      if (gameState.isDay !== undefined) {
        if (gameState.isDay) {
          document.body.classList.add('day-mode');
        } else {
          document.body.classList.remove('day-mode');
        }
      }
      
      if (gameState.players) {
        positionCardsInCircle(gameState.players);
        updateHostOnlyButtons();
        renderSkillButtons();
      }
    });

    // Handle initial game state
    socket.on('initialGameState', (state) => {
      console.log('[initialGameState]', state);
      gameState = state;
      
      // Update score displays
      if (gameState.partyCount !== undefined) {
        document.getElementById('partyCount').textContent = gameState.partyCount;
      }
      if (gameState.scandalScore !== undefined) {
        document.getElementById('scandalScore').textContent = gameState.scandalScore;
      }
      if (gameState.closeKnotScore !== undefined) {
        document.getElementById('closeKnotScore').textContent = gameState.closeKnotScore;
      }
      if (gameState.voteCount !== undefined) {
        document.getElementById('voteCount').textContent = gameState.voteCount;
      }
      if (gameState.loveCount !== undefined) {
        loveCount.textContent = gameState.loveCount;
      }
      if (gameState.hateCount !== undefined) {
        hateCount.textContent = gameState.hateCount;
      }
      
      // Update day/night mode
      if (gameState.isDay !== undefined) {
        if (gameState.isDay) {
          document.body.classList.add('day-mode');
        } else {
          document.body.classList.remove('day-mode');
        }
      }
      
      if (gameState.players) {
        positionCardsInCircle(gameState.players);
        updateHostOnlyButtons();
        renderSkillButtons();
      }
    });

    // --- Room Join Logic ---
    function getQueryParams() {
      const params = {};
      window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(str,key,value) {
        params[key] = decodeURIComponent(value);
      });
      return params;
    }
    const params = getQueryParams();
    const roomId = params.roomId || '00000';
    let myName = params.name || '';
    const password = params.password || '';
    const roomName = params.roomname || '';
    const maxPlayers = params.maxPlayers || 6;
    const isCreateRoom = params.createRoom === '1';
    if (!myName) {
      myName = prompt('Enter your name:');
    }
    if (isCreateRoom) {
      // Host: create the room first, then join
      socket.emit('createRoom', { roomId, password, maxPlayers, hostName: myName, roomName }, (res) => {
        if (res.success) {
          socket.emit('joinRoom', { roomId, playerName: myName }, (res2) => {
            if (!res2.success) {
              alert(res2.message || 'Failed to join room.');
              window.location.href = 'joining.html';
            }
          });
        } else {
          alert(res.message || 'Failed to create test room.');
          window.location.href = 'joining.html';
        }
      });
    } else {
      // Regular player: just join
      socket.emit('joinRoom', { roomId, playerName: myName }, (res) => {
        if (!res.success) {
          alert(res.message || 'Failed to join room.');
          window.location.href = 'joining.html';
        }
      });
    }

    // --- Host-Only Controls and Default State ---
    function updateHostOnlyButtons() {
      if (!gameState || !gameState.players) return;
      const me = gameState.players.find(p => p.id === socket.id);
      const isHost = me && me.isHost;
      document.querySelectorAll('.host-only').forEach(btn => {
        btn.disabled = !isHost;
      });
      // Only host can switch day/night
      const toggleStageBtn = document.getElementById('toggleStageBtn');
      if (toggleStageBtn) toggleStageBtn.disabled = !isHost;
    }

    // --- Skill Buttons ---
    function createSkillButton(role, used, enabled, onClick) {
      const btn = document.createElement('button');
      btn.className = 'skill-btn';
      btn.textContent = getSkillButtonLabel(role);
      btn.disabled = !enabled || used;
      btn.style.margin = '0 8px';
      btn.onclick = onClick;
      return btn;
    }
    function getSkillButtonLabel(role) {
      switch (role) {
        case 'Wind': return 'Mislead';
        case 'Kennedi': return 'Protecting Party';
        case 'Michael': return 'Find Abby';
        case 'Ker': return 'The Chosen One';
        case 'Jack': return 'Molest';
        default: return 'Skill';
      }
    }

    // --- Ker's Popup ---
    function showKerPopup() {
      const popup = document.createElement('div');
      popup.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fffbe7;border:2px solid #e2c391;padding:24px;z-index:2000;border-radius:16px;box-shadow:0 2px 18px #23202a22;';
      popup.innerHTML = `<b>The Chosen One</b><br><br>Pick the helper to swap:<br><input id="kerHelper" style="width:180px;"><br><br>Pick the non-helper candidate:<br><input id="kerNonHelper" style="width:180px;"><br><br><button id="kerSubmit">Submit</button> <button id="kerCancel">Cancel</button>`;
      document.body.appendChild(popup);
      document.getElementById('kerSubmit').onclick = function() {
        const helper = document.getElementById('kerHelper').value;
        const nonHelper = document.getElementById('kerNonHelper').value;
        socket.emit('gameAction', { roomId, action: 'theChosenOne', data: { oldHelper: helper, newHelper: nonHelper }, playerName: me.name });
        document.body.removeChild(popup);
      };
      document.getElementById('kerCancel').onclick = function() {
        document.body.removeChild(popup);
      };
    }

    // --- Default State on Load ---
    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.remove('day-mode'); // Night mode by default
      // Set all counts to 0
      document.querySelectorAll('.score-value').forEach(el => el.textContent = '0');
      loveCount.textContent = '0';
      hateCount.textContent = '0';
      // Disable all action buttons by default
      document.querySelectorAll('.action-btn, .reset-btn, .vote-btn').forEach(btn => btn.disabled = true);
      // Skill buttons will be rendered by renderSkillButtons

      // --- Host-Only Button Event Listeners ---
      const hostBtnMap = [
        { id: 'partyPlusBtn', action: { action: 'updateCount', data: { countType: 'party', delta: 1 } } },
        { id: 'partyMinusBtn', action: { action: 'updateCount', data: { countType: 'party', delta: -1 } } },
        { id: 'scandalPlusBtn', action: { action: 'updateCount', data: { countType: 'scandal', delta: 1 } } },
        { id: 'scandalMinusBtn', action: { action: 'updateCount', data: { countType: 'scandal', delta: -1 } } },
        { id: 'closeKnotPlusBtn', action: { action: 'updateCount', data: { countType: 'closeKnot', delta: 1 } } },
        { id: 'closeKnotMinusBtn', action: { action: 'updateCount', data: { countType: 'closeKnot', delta: -1 } } },
        { id: 'votePlusBtn', action: { action: 'updateCount', data: { countType: 'vote', delta: 1 } } },
        { id: 'voteMinusBtn', action: { action: 'updateCount', data: { countType: 'vote', delta: -1 } } },
        { id: 'takeActionBtn', action: { action: 'takeLoveHateAction', data: {} } },
        { id: 'resetLoveHateBtn', action: { action: 'resetLoveHateCount', data: {} } },
        { id: 'resetVoteBtn', action: { action: 'resetVote', data: {} } },
        { id: 'restartBtn', action: { action: 'restartGame', data: {} } },
        { id: 'toggleStageBtn', action: { action: 'switchDayNight', data: {} }, isToggle: true }
      ];
      hostBtnMap.forEach(({ id, action, isToggle }) => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.addEventListener('click', () => {
            if (id === 'toggleStageBtn') {
              // Toggle day/night
              const isDay = !document.body.classList.contains('day-mode');
              socket.emit('gameAction', { roomId, action: 'switchDayNight', data: { isDay }, playerName: myName });
            } else {
              socket.emit('gameAction', { roomId, ...action, playerName: myName });
            }
          });
        }
      });
    });

    function renderRoleCards() {
      const container = document.getElementById('roleCardsCircle');
      container.innerHTML = '';
      const n = playerNames.length;
      const radius = 240;
      
      // Role info for tooltip
      const roleInfo = {
        michael: {name:'Michael', team:'Cheater', power:'Can see Wind\'s card. Can guess Abby for instant win'},
        wind: {name:'Wind', team:'Cheater', power:'Can see Michael\'s card. Molest: +2 Scandal; Mislead: flip Love‚ÜíHate'},
        jack: {name:'Jack', team:'Cheater', power:'Hidden from everyone except self'},
        abby: {name:'Abby', team:'Keeper', power:'Can see all Cheaters except Jack'},
        kennedi: {name:'Kennedi', team:'Keeper', power:'Can see own card. All Helpers count as Love'},
        ker: {name:'Ker', team:'Keeper', power:'Can see own card. Can swap one Helper'},
        kiko: {name:'Kiko', team:'Keeper (Pet)', power:'No special power'},
        knox: {name:'Knox', team:'Keeper (Pet)', power:'No special power'},
        nash: {name:'Nash', team:'Keeper (Pet)', power:'No special power'}
      };

      // Show cards face-up based on role visibility rules
      const isAbby = myRole === 'abby';
      const isMichael = myRole === 'michael';
      const isWind = myRole === 'wind';
      
      // Calculate angles for players with equal spacing
      const angles = Array.from({length: n}, (_, i) => {
        return (Math.PI / 2) + (i * (2 * Math.PI / n));
      });

      playerNames.forEach((name, i) => {
        const angle = angles[i];
        const x = radius * Math.cos(angle);
        const y = radius * Math.sin(angle);
        
        const card = document.createElement('img');
        card.className = 'role-card' + (i === myIndex ? ' me' : '');
        card.style.left = `calc(50% + ${x}px - 45px)`;
        card.style.top = `calc(50% + ${y}px - 67.5px)`;
        
        // Show card face-up based on role-specific rules
        const role = shuffledRoles[i];
        let shouldShowCard = false;
        
        if (i === myIndex) {
          // Everyone can see their own card
          shouldShowCard = true;
        } else if (isAbby) {
          // Abby can see all Cheaters except Jack
          shouldShowCard = ['michael', 'wind'].includes(role);
        } else if (isMichael) {
          // Michael can see Wind's card
          shouldShowCard = role === 'wind';
        } else if (isWind) {
          // Wind can see Michael's card
          shouldShowCard = role === 'michael';
        }
        
        card.src = shouldShowCard ? roleImages[role] : backsideImg;
        card.alt = shouldShowCard ? role : 'Hidden';
        container.appendChild(card);

        // Add role intro tooltip for myself only
        if (i === myIndex) {
          const tooltip = document.createElement('div');
          tooltip.className = 'role-intro-tooltip';
          const info = roleInfo[myRole];
          tooltip.innerHTML = `<div class='role-title'>${info.name} (${info.team})</div><div><b>Power:</b> ${info.power}</div>`;
          card.addEventListener('mouseenter',()=>{tooltip.classList.add('active');});
          card.addEventListener('mouseleave',()=>{tooltip.classList.remove('active');});
          container.appendChild(tooltip);
        }

        // Add player name label with adjusted positioning
        const nameLabel = document.createElement('div');
        nameLabel.className = 'player-name-label';
        const nameOffsetY = y > 0 ? 100 : -100;
        nameLabel.style.left = `calc(50% + ${x}px)`;
        nameLabel.style.top = `calc(50% + ${y + nameOffsetY}px)`;
        nameLabel.textContent = name;
        container.appendChild(nameLabel);
      });
    }

    // Handle Ker's skill
    function handleKerSkill() {
      const dialog = document.createElement('div');
      dialog.className = 'ker-skill-dialog';
      dialog.innerHTML = `
        <div class="dialog-content">
          <h3>The Chosen One</h3>
          <div class="input-section">
            <label>Pick the helper to swap:</label>
            <input type="text" id="helperToSwap" placeholder="Enter helper name">
          </div>
          <div class="input-section">
            <label>Pick the non-helper candidate:</label>
            <input type="text" id="newHelper" placeholder="Enter non-helper name">
          </div>
          <button onclick="submitKerSwap()">Confirm Swap</button>
          <button onclick="closeKerDialog()">Cancel</button>
        </div>
      `;
      document.body.appendChild(dialog);
    }

    function submitKerSwap() {
      const helperToSwap = document.getElementById('helperToSwap').value;
      const newHelper = document.getElementById('newHelper').value;
      if (helperToSwap && newHelper) {
        socket.emit('kerSwap', { helperToSwap, newHelper });
        showUIMessage(`Ker swap ${helperToSwap} helper to ${newHelper} as new helper!`, 10000);
        closeKerDialog();
      }
    }

    function closeKerDialog() {
      const dialog = document.querySelector('.ker-skill-dialog');
      if (dialog) dialog.remove();
    }

    // Handle Wind and Kennedi's skill phase
    function handleLoveHate(action) {
      if (isSkillPhase) return;
      
      if (action === 'love') {
        tempLoveCount++;
      } else {
        tempHateCount++;
      }
      
      // Disable love/hate buttons after use
      document.getElementById('loveBtn').disabled = true;
      document.getElementById('hateBtn').disabled = true;
      
      // Enable Wind and Kennedi's skills
      isSkillPhase = true;
      if (windSkillBtn) windSkillBtn.disabled = false;
      if (kennediSkillBtn) kennediSkillBtn.disabled = false;
      
      showUIMessage("Wind and Kennedi are allowed to use their skills right now!", 10000);
      
      // After 10 seconds, disable skills and apply temp counts
      setTimeout(() => {
        isSkillPhase = false;
        if (windSkillBtn) windSkillBtn.disabled = true;
        if (kennediSkillBtn) kennediSkillBtn.disabled = true;
        
        // Apply the temporary counts
        if (tempLoveCount > 0) {
          socket.emit('updateLoveCount', tempLoveCount);
        }
        if (tempHateCount > 0) {
          socket.emit('updateHateCount', tempHateCount);
        }
        
        // Reset temp counts
        tempLoveCount = 0;
        tempHateCount = 0;
        
        // Re-enable love/hate buttons
        document.getElementById('loveBtn').disabled = false;
        document.getElementById('hateBtn').disabled = false;
      }, 10000);
    }

    // Handle Wind's molest skill
    function handleWindMolest() {
      if (!isSkillPhase) return;
      socket.emit('updateScandal', 2);
      showUIMessage("Wind used Molest! Scandal +2", 5000);
      if (windSkillBtn) windSkillBtn.disabled = true;
    }

    // Handle Wind's mislead skill
    function handleWindMislead() {
      if (!isSkillPhase) return;
      // Implementation for flipping Love to Hate
      showUIMessage("Wind used Mislead! Flipped Love to Hate", 5000);
      if (windSkillBtn) windSkillBtn.disabled = true;
    }

    // Handle Kennedi's protect skill
    function handleKennediProtect() {
      if (!isSkillPhase) return;
      // Implementation for making all Helpers count as Love
      showUIMessage("Kennedi used Protect! All Helpers count as Love", 5000);
      if (kennediSkillBtn) kennediSkillBtn.disabled = true;
    }

    // Handle Michael's find Abby skill
    function handleMichaelFindAbby() {
      showUIMessage("Michael thinks he has found Abby now!", 5000);
      if (michaelSkillBtn) michaelSkillBtn.disabled = true;
    }

    // Add CSS for Ker's skill dialog
    const style = document.createElement('style');
    style.textContent = `
      .ker-skill-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .dialog-content {
        background: #fffbe7;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #e2c391;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      .input-section {
        margin: 15px 0;
      }
      .input-section label {
        display: block;
        margin-bottom: 5px;
        color: #5a4327;
      }
      .input-section input {
        width: 100%;
        padding: 8px;
        border: 1px solid #e2c391;
        border-radius: 4px;
      }
      .dialog-content button {
        margin: 5px;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        background: #e2c391;
        color: #5a4327;
        cursor: pointer;
      }
      .dialog-content button:hover {
        background: #bfa16a;
      }
    `;
    document.head.appendChild(style);

    // Host controls
    function initializeHostControls() {
      if (!isHost) return;

      const hostControls = document.createElement('div');
      hostControls.className = 'host-controls';
      hostControls.innerHTML = `
        <button class="host-button" onclick="toggleDayNight()">Toggle Day/Night</button>
        <button class="host-button" onclick="restartGame()">Restart Game</button>
      `;
      document.body.appendChild(hostControls);

      const countControls = document.createElement('div');
      countControls.className = 'count-controls';
      countControls.innerHTML = `
        <button class="count-button" onclick="updateLoveCount(1)">Love +1</button>
        <button class="count-button" onclick="updateLoveCount(-1)">Love -1</button>
        <button class="count-button" onclick="updateHateCount(1)">Hate +1</button>
        <button class="count-button" onclick="updateHateCount(-1)">Hate -1</button>
        <button class="count-button" onclick="updateScandal(1)">Scandal +1</button>
        <button class="count-button" onclick="updateScandal(-1)">Scandal -1</button>
      `;
      document.body.appendChild(countControls);
    }

    function toggleDayNight() {
      if (!isHost) return;
      const isNight = document.body.classList.toggle('night-mode');
      document.querySelector('.table').classList.toggle('night-mode', isNight);
      document.querySelectorAll('.role-card').forEach(card => card.classList.toggle('night-mode', isNight));
      document.querySelectorAll('.player-name-label').forEach(label => label.classList.toggle('night-mode', isNight));
      document.querySelectorAll('.host-button, .count-button').forEach(btn => btn.classList.toggle('night-mode', isNight));
      socket.emit('toggleDayNight', isNight);
    }

    function restartGame() {
      if (!isHost) return;
      if (confirm('Are you sure you want to restart the game?')) {
        socket.emit('restartGame');
      }
    }

    function updateLoveCount(delta) {
      if (!isHost) return;
      socket.emit('updateLoveCount', delta);
    }

    function updateHateCount(delta) {
      if (!isHost) return;
      socket.emit('updateHateCount', delta);
    }

    function updateScandal(delta) {
      if (!isHost) return;
      socket.emit('updateScandal', delta);
    }

    // Socket event handlers
    socket.on('toggleDayNight', (isNight) => {
      document.body.classList.toggle('night-mode', isNight);
      document.querySelector('.table').classList.toggle('night-mode', isNight);
      document.querySelectorAll('.role-card').forEach(card => card.classList.toggle('night-mode', isNight));
      document.querySelectorAll('.player-name-label').forEach(label => label.classList.toggle('night-mode', isNight));
      document.querySelectorAll('.host-button, .count-button').forEach(btn => btn.classList.toggle('night-mode', isNight));
    });

    socket.on('gameRestarted', () => {
      location.reload();
    });

    // Initialize host controls when the game starts
    socket.on('gameStarted', () => {
      initializeHostControls();
    });

    // Find the reset vote button handler and update it to only enable the vote button
    const resetVoteBtn = document.getElementById('resetVoteBtn');
    if (resetVoteBtn) {
      resetVoteBtn.addEventListener('click', () => {
        // Only enable the vote button
        const voteBtn = document.getElementById('voteSubmitBtn');
        if (voteBtn) {
          voteBtn.disabled = false;
          voteBtn.style.opacity = '1';
        }
        // Optionally show a message overlay if you want
        const overlay = document.getElementById('voteMessageOverlay');
        if (overlay) {
          overlay.style.display = 'block';
          setTimeout(() => {
            overlay.style.display = 'none';
            if (voteBtn) {
              voteBtn.disabled = true;
              voteBtn.style.opacity = '0.5';
            }
          }, 10000);
        }
      });
    }
  </script>
</body>
</html>
