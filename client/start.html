<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game Room – Who's Cheating?</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body.ghibli-game {
      background: linear-gradient(120deg, #23202a 0%, #2d1c0b 30%, #22304a 80%, #1a2233 100%);
      font-family: 'Segoe Print', 'Comic Sans MS', 'Arial', cursive;
      color: #5a4327;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    body.ghibli-game.day-stage {
      background: linear-gradient(120deg, #fffbe7 0%, #ffe7b2 40%, #ffdca8 80%, #ffe2c3 100%);
      color: #a07c4f;
    }
    body.ghibli-game.day-stage .circle-table {
      background: radial-gradient(circle at 60% 40%, #fffbe7 60%, #ffe7b2 100%);
      filter: none;
      box-shadow: 0 16px 64px 0 #ffdca888, 0 0 0 24px #fffbe7cc inset, 0 0 0 8px #ffe7b2cc inset;
    }
    body.ghibli-game.day-stage .player-name-label {
      color: #e2a84f;
      background: #fffbe7ee;
      border: 1.5px solid #ffdca8;
      box-shadow: 0 2px 12px 0 #ffdca822, 0 0 8px 0 #ffe7b2cc;
      font-family: 'Caveat', 'Segoe Print', 'Comic Sans MS', cursive;
      font-style: normal;
      font-weight: bold;
    }
    body.ghibli-game.day-stage .circle-table-container {
      filter: none;
    }
    body.ghibli-game.day-stage .floating-hearts .broken-heart,
    body.ghibli-game.day-stage .floating-hearts .loving-heart {
      display: none;
    }
    body.ghibli-game.day-stage .floating-hearts .flower {
      display: block;
    }
    body.ghibli-game.day-stage .ghibli-mist,
    body.ghibli-game.day-stage .ghibli-fingerprint,
    body.ghibli-game.day-stage .ghibli-stars,
    body.ghibli-game.day-stage .ghibli-moon {
      display: none !important;
    }
    /* Day sun */
    .ghibli-sun {
      position: fixed;
      right: 5vw;
      top: 4vw;
      width: 64px;
      height: 64px;
      z-index: 1;
      opacity: 0.18;
      pointer-events: none;
      display: none;
    }
    body.ghibli-game.day-stage .ghibli-sun {
      display: block;
    }
    /* Floating flowers for day */
    .flower {
      position: absolute;
      opacity: 0.22;
      animation: float-heart 16s linear infinite;
      will-change: transform, opacity;
      display: none;
    }
    .flower svg {
      display: block;
    }
    /* Confetti for party */
    .confetti {
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      pointer-events: none;
      z-index: 4;
      display: none;
    }
    body.ghibli-game.day-stage .confetti {
      display: block;
    }
    /* Soft vignette around the page */
    body.ghibli-game::before {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      background:
        radial-gradient(ellipse at 50% 60%, rgba(30,20,40,0) 60%, rgba(30,20,40,0.85) 100%),
        linear-gradient(120deg, rgba(60,70,110,0.22) 0%, rgba(60,70,110,0.33) 100%);
      transition: opacity 0.5s;
    }
    /* Animated mist/fog overlay */
    .ghibli-mist {
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      pointer-events: none;
      z-index: 1;
      opacity: 0.22;
      background: url('https://www.transparenttextures.com/patterns/foggy-birds.png');
      animation: mist-move 24s linear infinite alternate;
      mix-blend-mode: lighten;
    }
    @keyframes mist-move {
      0% { background-position: 0 0; }
      100% { background-position: 120px 60px; }
    }
    /* Faint fingerprint watermark */
    .ghibli-fingerprint {
      position: fixed;
      right: 3vw;
      bottom: 2vw;
      width: 120px;
      height: 120px;
      z-index: 2;
      opacity: 0.10;
      pointer-events: none;
      filter: blur(0.5px) grayscale(0.2);
    }
    .circle-table-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100vw;
      height: 100vh;
    }
    .circle-table {
      background: radial-gradient(circle at 60% 40%, #6b5a3a 55%, #2d1c0b 100%);
      filter: grayscale(0.18) brightness(0.85) blur(0.5px);
      box-shadow: 0 12px 48px 0 #23202a, 0 0 0 24px #23202a33 inset, 0 0 0 8px #7bb0e633 inset;
      border-radius: 50%;
      width: 440px;
      height: 440px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border: 8px solid #bfa16a;
    }
    .table-items {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 2;
    }
    .plate-stack {
      width: 40px;
      height: 10px;
      background: #fffbe7;
      border-radius: 50%;
      border: 2px solid #e2c391;
      margin-bottom: 6px;
      box-shadow: 0 2px 8px 0 #e2c39122;
    }
    .glasses {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }
    .glass {
      width: 10px;
      height: 24px;
      background: #cbe6d6;
      border-radius: 5px 5px 8px 8px / 7px 7px 12px 12px;
      border: 1.2px solid #a0bfa1;
      opacity: 0.85;
    }
    .napkin {
      width: 22px;
      height: 10px;
      background: #f7ecd7;
      border-radius: 4px;
      border: 1px solid #e2c391;
      margin-top: 4px;
      margin-bottom: 2px;
      position: relative;
    }
    .chopsticks {
      position: absolute;
      width: 16px;
      height: 2px;
      background: #bfa16a;
      border-radius: 2px;
      top: 4px;
      left: 3px;
      box-shadow: 0 2px 4px #e2c39144;
    }
    .chopsticks::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 2px;
      background: #e2c391;
      border-radius: 2px;
      top: 3px;
      left: 2px;
      opacity: 0.7;
    }
    .role-cards-circle {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 600px;
      height: 600px;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    .role-card {
      position: absolute;
      width: 110px;
      height: 160px;
      border-radius: 16px;
      box-shadow: 0 6px 24px 0 rgba(90, 67, 39, 0.13);
      border: 3px solid #e2c391;
      background: #fffbe7;
      object-fit: cover;
      pointer-events: auto;
      transition: transform 0.2s, box-shadow 0.2s;
      user-select: none;
    }
    .role-card:hover {
      transform: scale(1.13) translateY(-8px);
      box-shadow: 0 12px 36px 0 rgba(90, 67, 39, 0.22), 0 0 0 8px #e2c39144;
      z-index: 20;
    }
    .role-card.me {
      box-shadow: 0 0 0 6px #bfa16a99, 0 6px 24px 0 rgba(90, 67, 39, 0.13);
      border: 3.5px solid #7a5a2f;
      z-index: 10;
    }
    .player-name-label {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.02rem;
      color: #e2c391;
      background: rgba(40,30,20,0.72);
      border-radius: 8px;
      border: 1.5px solid #7bb0e6;
      padding: 4px 14px;
      white-space: nowrap;
      box-shadow: 0 2px 8px 0 #7bb0e644, 0 0 8px 0 #23202a99;
      pointer-events: none;
      font-family: 'Caveat', 'Segoe Print', 'Comic Sans MS', cursive;
      font-style: italic;
      font-weight: 500;
    }
    @media (max-width: 600px) {
      .circle-table { width: 98vw; height: 98vw; min-width: 200px; min-height: 200px; }
      .role-cards-circle { width: 98vw; height: 98vw; }
      .role-card { width: 60px; height: 88px; }
      .player-name-label { font-size: 0.85rem; padding: 2px 7px; }
    }
    /* Floating broken hearts */
    .floating-hearts {
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      pointer-events: none;
      z-index: 3;
    }
    .broken-heart {
      position: absolute;
      opacity: 0.18;
      animation: float-heart 14s linear infinite;
      will-change: transform, opacity;
    }
    .broken-heart svg {
      display: block;
    }
    /* Keyframes for floating hearts */
    @keyframes float-heart {
      0% { transform: translateY(0) scale(1) rotate(-8deg); opacity: 0.18; }
      10% { opacity: 0.28; }
      50% { transform: translateY(-60vh) scale(1.12) rotate(8deg); opacity: 0.22; }
      90% { opacity: 0.28; }
      100% { transform: translateY(-100vh) scale(1.18) rotate(-8deg); opacity: 0.10; }
    }
    /* Starfield */
    .ghibli-stars {
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      pointer-events: none;
      z-index: 0;
      background: transparent;
    }
    .ghibli-stars span {
      position: absolute;
      display: block;
      border-radius: 50%;
      background: #fffbe7;
      opacity: 0.7;
      filter: blur(0.5px);
      animation: twinkle 3.5s infinite alternate;
    }
    @keyframes twinkle {
      0%,100% { opacity: 0.7; }
      50% { opacity: 0.3; }
    }
    /* Crescent moon */
    .ghibli-moon {
      position: fixed;
      right: 5vw;
      top: 4vw;
      width: 64px;
      height: 64px;
      z-index: 1;
      opacity: 0.18;
      pointer-events: none;
    }
    /* Title badge day style */
    body.ghibli-game.day-stage #gameTitleBadge {
      background: linear-gradient(120deg,#fffbe7 60%,#ffe7b2 100%);
      border: 2.5px solid #ffdca8;
      border-radius: 22px 18px 32px 18px/18px 32px 18px 32px;
      box-shadow: 0 4px 18px 0 #ffdca855, 0 2px 0 #fffbe7 inset;
      filter: none;
      min-width: 140px;
      padding: 18px 38px 14px 38px;
      position: relative;
    }
    body.ghibli-game.day-stage #gameTitleText {
      color: #e2a84f;
      font-size: 1.7rem;
      font-family: 'Caveat','Segoe Print','Comic Sans MS',cursive;
      font-style: normal;
      font-weight: bold;
      text-shadow: 0 2px 0 #fffbe7, 0 4px 12px #ffdca844;
      letter-spacing: 1.5px;
      filter: none;
      transition: all 0.3s;
    }
    body.ghibli-game.day-stage #gameTitleBadge::after {
      content: '';
      position: absolute;
      left: 12px; top: 8px; width: 18px; height: 18px;
      background: radial-gradient(circle,#ffdca8 60%,#fffbe7 100%);
      border-radius: 50%;
      box-shadow: 0 0 8px 2px #ffe7b2cc;
      opacity: 0.7;
      z-index: 2;
    }
    body.ghibli-game.day-stage #gameTitleBadge::before {
      content: '';
      position: absolute;
      right: 18px; bottom: 10px; width: 12px; height: 12px;
      background: radial-gradient(circle,#f7b2b7 60%,#ffe7b2 100%);
      border-radius: 50%;
      box-shadow: 0 0 6px 1px #ffdca8cc;
      opacity: 0.7;
      z-index: 2;
    }
    /* Game rule summary box */
    .game-rule-summary {
      position: fixed;
      top: 160px;
      right: 38px;
      width: 340px;
      max-width: 40vw;
      z-index: 120;
      padding: 18px 18px 14px 18px;
      font-size: 1.04rem;
      font-family: 'Caveat','Segoe Print','Comic Sans MS',cursive;
      border-radius: 18px 22px 18px 22px/22px 18px 22px 18px;
      box-shadow: 0 2px 18px 0 #23202a22,0 2px 0 #fffbe7 inset;
      background: linear-gradient(120deg,#23202a 60%,#6b5a3a 100%);
      color: #e2c391;
      border: 2px solid #7bb0e6;
      transition: all 0.3s;
      min-height: 120px;
      line-height: 1.5;
    }
    .game-rule-summary .rule-title {
      font-size: 1.13rem;
      font-weight: bold;
      margin-bottom: 8px;
      color: #7bb0e6;
      letter-spacing: 1px;
    }
    body.ghibli-game.day-stage .game-rule-summary {
      background: linear-gradient(120deg,#fffbe7 60%,#ffe7b2 100%);
      color: #a07c4f;
      border: 2px solid #ffdca8;
      box-shadow: 0 2px 18px 0 #ffdca822,0 2px 0 #fffbe7 inset;
    }
    body.ghibli-game.day-stage .game-rule-summary .rule-title {
      color: #e2a84f;
    }
    /* Role intro tooltip */
    .role-intro-tooltip {
      position: fixed;
      left: 50%;
      bottom: 180px;
      transform: translateX(-50%);
      min-width: 220px;
      max-width: 320px;
      z-index: 300;
      background: linear-gradient(120deg,#23202a 60%,#6b5a3a 100%);
      color: #e2c391;
      border: 2px solid #7bb0e6;
      border-radius: 18px 22px 18px 22px/22px 18px 22px 18px;
      box-shadow: 0 2px 18px 0 #23202a55,0 2px 0 #fffbe7 inset;
      font-family: 'Caveat','Segoe Print','Comic Sans MS',cursive;
      font-size: 1.08rem;
      padding: 18px 18px 14px 18px;
      line-height: 1.5;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      display: none;
    }
    .role-card.me:hover + .role-intro-tooltip,
    .role-intro-tooltip.active {
      display: block;
      opacity: 1;
      pointer-events: auto;
    }
    body.ghibli-game.day-stage .role-intro-tooltip {
      background: linear-gradient(120deg,#fffbe7 60%,#ffe7b2 100%);
      color: #a07c4f;
      border: 2px solid #ffdca8;
      box-shadow: 0 2px 18px 0 #ffdca822,0 2px 0 #fffbe7 inset;
    }
    .role-intro-tooltip .role-title {
      font-size: 1.18rem;
      font-weight: bold;
      margin-bottom: 6px;
      color: #7bb0e6;
      letter-spacing: 1px;
    }
    body.ghibli-game.day-stage .role-intro-tooltip .role-title {
      color: #e2a84f;
    }
    .game-title {
      font-size: 2.5em;
      color: #2c3e50;
      text-align: center;
      margin: 20px 0;
      font-family: 'Playfair Display', serif;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    .game-stats-box {
      background: rgba(255, 251, 231, 0.95);
      border-radius: 15px;
      padding: 15px;
      margin: 0;
      width: 180px;
      box-shadow: 0 2px 18px 0 #e2c39133, 0 2px 0 #fffbe7 inset;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border: 2px solid #e2c391;
      position: fixed;
      top: 120px;
      left: 38px;
      transform: none;
      transition: all 0.3s ease;
    }

    .night-mode .game-stats-box {
      background: rgba(44, 62, 80, 0.95);
      border: 2px solid #34495e;
      box-shadow: 0 2px 18px 0 rgba(52, 73, 94, 0.3), 0 2px 0 #2c3e50 inset;
    }

    .night-mode .stat-label {
      color: #ecf0f1;
    }

    .night-mode .stat-value {
      color: #3498db;
    }

    .night-mode .stat-item {
      border-bottom: 1px solid #34495e;
    }

    .stat-item {
      text-align: center;
      padding: 5px;
      border-bottom: 1px solid #e2c391;
    }
    .stat-item:last-child {
      border-bottom: none;
    }
    .stat-label {
      font-size: 0.9em;
      color: #2c3e50;
      margin-bottom: 3px;
      font-weight: bold;
    }
    .stat-value {
      font-size: 1.4em;
      color: #e2a84f;
      font-weight: bold;
    }
    .how-to-play {
      background: rgba(255, 251, 231, 0.95);
      border-radius: 15px;
      padding: 20px;
      margin: 20px;
      max-width: 400px;
      box-shadow: 0 2px 18px 0 #e2c39133, 0 2px 0 #fffbe7 inset;
      border: 2px solid #e2c391;
      max-height: 400px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #e2c391 #fffbe7;
      color: #8d6b2c;
    }

    .how-to-play::-webkit-scrollbar {
      width: 8px;
    }

    .how-to-play::-webkit-scrollbar-track {
      background: #fffbe7;
      border-radius: 4px;
    }

    .how-to-play::-webkit-scrollbar-thumb {
      background-color: #e2c391;
      border-radius: 4px;
      border: 2px solid #fffbe7;
    }

    .how-to-play::-webkit-scrollbar-thumb:hover {
      background-color: #e2a84f;
    }

    .how-to-play .role-section {
      color: #b97a1a;
      font-weight: bold;
      margin-top: 10px;
      margin-bottom: 4px;
    }

    .how-to-play .role-description {
      color: #7a5a1a;
      margin-bottom: 8px;
    }

    .how-to-play b {
      color: #e2a84f;
    }

    .night-mode .how-to-play {
      background: rgba(34, 45, 65, 0.97);
      border: 2px solid #34495e;
      box-shadow: 0 2px 18px 0 rgba(52, 73, 94, 0.3), 0 2px 0 #2c3e50 inset;
      color: #cfd8dc;
    }

    .night-mode .how-to-play .role-section {
      color: #5dade2;
    }

    .night-mode .how-to-play .role-description {
      color: #b0bec5;
    }

    .night-mode .how-to-play b {
      color: #5dade2;
    }

    /* Add some basic style for skill buttons */
    .skill-btn {
      padding: 10px 18px;
      font-size: 1.08em;
      font-family: inherit;
      background: linear-gradient(100deg, #e2c391 80%, #f7e7c6 100%);
      color: #5a4327;
      border: 2px solid #bfa16a;
      border-radius: 12px 24px 12px 24px / 24px 12px 24px 12px;
      box-shadow: 2px 4px 12px 0 rgba(90, 67, 39, 0.13), 0 1.5px 0 #e2c391 inset, 0 0 0 4px #e2c39122 inset;
      cursor: pointer;
      margin-bottom: 2px;
      transition: box-shadow 0.18s, transform 0.15s, background 0.18s, border 0.18s;
    }
    .skill-btn:hover {
      background: linear-gradient(100deg, #f9eacb 80%, #e7cfa1 100%);
      box-shadow: 0 8px 24px 0 rgba(90, 67, 39, 0.18), 0 2px 0 #e2c391 inset, 0 0 0 6px #e2c39133 inset;
      transform: translateY(-2px) scale(1.03) rotate(-1deg);
      border-color: #a07c4f;
    }
    .skill-btn:disabled, .skill-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: linear-gradient(100deg, #e2c391 80%, #e2c391 100%);
      border-color: #bfa16a;
      box-shadow: none;
      color: #a07c4f;
    }
    .skill-btn:disabled:hover, .skill-btn.disabled:hover {
      background: linear-gradient(100deg, #e2c391 80%, #e2c391 100%);
      box-shadow: none;
      transform: none;
      border-color: #bfa16a;
    }
    #testStartBtn:hover {
      background: linear-gradient(100deg, #f9eacb 80%, #e7cfa1 100%);
      box-shadow: 0 16px 48px 0 rgba(90, 67, 39, 0.28), 0 4px 0 #e2c391 inset, 0 0 0 12px #e2c39133 inset;
      transform: translateY(-3px) scale(1.03) rotate(-1deg);
      border-color: #a07c4f;
    }
    #finishTalkingBtn:hover {
      background: linear-gradient(100deg, #f9eacb 80%, #e7cfa1 100%);
      box-shadow: 0 16px 48px 0 rgba(90, 67, 39, 0.28), 0 4px 0 #e2c391 inset, 0 0 0 12px #e2c39133 inset;
      transform: translateY(-3px) scale(1.03) rotate(-1deg);
      border-color: #a07c4f;
    }
    #muteBtn:hover {
      background: linear-gradient(100deg, #f9eacb 80%, #e2a1e1 100%);
      box-shadow: 0 16px 48px 0 rgba(90, 67, 39, 0.18), 0 4px 0 #e2c391 inset, 0 0 0 12px #e2c39133 inset;
      transform: translateY(-3px) scale(1.03) rotate(-1deg);
      border-color: #7bb0e6;
    }
    /* Custom disabled style for Finish Talking button */
    #finishTalkingBtn:disabled, #finishTalkingBtn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: linear-gradient(100deg, #b0b0b0 80%, #e2c391 100%);
      border-color: #bfa16a;
      box-shadow: none;
      color: #a07c4f;
      filter: grayscale(0.3) brightness(0.95);
    }
    #finishTalkingBtn:not(:disabled):not(.disabled) {
      background: linear-gradient(100deg, #e2c391 80%, #f7e7c6 100%);
      color: #5a4327;
      filter: none;
    }
    /* Shared disabled button style for all game buttons */
    .disabled-btn,
    .skill-btn:disabled, .skill-btn.disabled,
    #finishTalkingBtn:disabled, #finishTalkingBtn.disabled,
    #muteBtn:disabled, #muteBtn.disabled,
    #voteYesBtn:disabled, #voteYesBtn.disabled,
    #voteNoBtn:disabled, #voteNoBtn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: linear-gradient(100deg, #e2c391 80%, #e2c391 100%);
      border-color: #bfa16a;
      box-shadow: none;
      color: #a07c4f;
    }
    .skill-btn:disabled:hover, .skill-btn.disabled:hover,
    #finishTalkingBtn:disabled:hover, #finishTalkingBtn.disabled:hover,
    #muteBtn:disabled:hover, #muteBtn.disabled:hover,
    #voteYesBtn:disabled:hover, #voteYesBtn.disabled:hover,
    #voteNoBtn:disabled:hover, #voteNoBtn.disabled:hover {
      background: linear-gradient(100deg, #e2c391 80%, #e2c391 100%);
      box-shadow: none;
      transform: none;
      border-color: #bfa16a;
    }
    /* Hover effect for Love and Hate buttons */
    #voteYesBtn:hover {
      background: linear-gradient(100deg, #ffe7e7 80%, #ffe7b2 100%);
      box-shadow: 0 8px 24px 0 rgba(247, 178, 183, 0.18), 0 2px 0 #ffd6d6 inset, 0 0 0 6px #ffe7b244 inset;
      transform: translateY(-2px) scale(1.06) rotate(-1deg);
      border-color: #e2a84f;
      color: #c0392b;
    }
    #voteNoBtn:hover {
      background: linear-gradient(100deg, #ffd6d6 80%, #f7b2b7 100%);
      box-shadow: 0 8px 24px 0 rgba(231, 76, 60, 0.18), 0 2px 0 #f7b2b7 inset, 0 0 0 6px #ffd6d644 inset;
      transform: translateY(-2px) scale(1.06) rotate(1deg);
      border-color: #e74c3c;
      color: #a94442;
    }
    #voteSubmitBtn:hover {
      background: linear-gradient(100deg, #b2e7d7 80%, #7bb0e6 100%);
      box-shadow: 0 8px 24px 0 rgba(52, 152, 219, 0.18), 0 2px 0 #7bb0e6 inset, 0 0 0 6px #b2e7d744 inset;
      transform: translateY(-2px) scale(1.06) rotate(1deg);
      border-color: #3498db;
      color: #34495e;
    }
    .stat-btn {
      background: linear-gradient(100deg, #e2c391 80%, #f7e7c6 100%);
      color: #7a5a2f;
      border: 1.5px solid #bfa16a;
      border-radius: 8px;
      font-size: 1.1em;
      font-family: inherit;
      padding: 2px 10px;
      margin: 0 2px;
      cursor: pointer;
      transition: background 0.18s, color 0.18s, border 0.18s;
    }
    .stat-btn:hover {
      background: linear-gradient(100deg, #f9eacb 80%, #e7cfa1 100%);
      color: #a07c4f;
      border-color: #a07c4f;
    }
    .love-hate-box {
      background: rgba(255, 251, 231, 0.95);
      border-radius: 15px;
      padding: 15px;
      margin: 18px 0 0 0;
      width: 180px;
      box-shadow: 0 2px 18px 0 #e2c39133, 0 2px 0 #fffbe7 inset;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border: 2px solid #e2c391;
      position: fixed;
      top: 520px;
      left: 38px;
      transform: none;
      transition: all 0.3s ease;
      z-index: 120;
    }
    .night-mode .love-hate-box {
      background: rgba(44, 62, 80, 0.95);
      border: 2px solid #34495e;
      box-shadow: 0 2px 18px 0 rgba(52, 73, 94, 0.3), 0 2px 0 #2c3e50 inset;
    }
    #voteSubmitBtn:disabled, #voteSubmitBtn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: linear-gradient(100deg, #e2c391 80%, #e2c391 100%);
      border-color: #bfa16a;
      box-shadow: none;
      color: #a07c4f;
    }
    #voteSubmitBtn:disabled:hover, #voteSubmitBtn.disabled:hover {
      background: linear-gradient(100deg, #e2c391 80%, #e2c391 100%);
      box-shadow: none;
      transform: none;
      border-color: #bfa16a;
    }
  </style>
</head>
<body class="ghibli-game">
  <div class="ghibli-mist"></div>
  <div class="ghibli-stars">
    <span style="left:8vw;top:12vh;width:2.5px;height:2.5px;animation-delay:0s;"></span>
    <span style="left:18vw;top:22vh;width:1.5px;height:1.5px;animation-delay:1.2s;"></span>
    <span style="left:38vw;top:8vh;width:2.2px;height:2.2px;animation-delay:2.1s;"></span>
    <span style="left:62vw;top:18vh;width:1.8px;height:1.8px;animation-delay:0.7s;"></span>
    <span style="left:78vw;top:12vh;width:2.7px;height:2.7px;animation-delay:2.8s;"></span>
    <span style="left:88vw;top:28vh;width:1.2px;height:1.2px;animation-delay:1.7s;"></span>
    <span style="left:55vw;top:6vh;width:1.9px;height:1.9px;animation-delay:0.3s;"></span>
    <span style="left:25vw;top:18vh;width:2.1px;height:2.1px;animation-delay:2.3s;"></span>
    <span style="left:70vw;top:10vh;width:1.6px;height:1.6px;animation-delay:1.1s;"></span>
    <span style="left:48vw;top:24vh;width:2.3px;height:2.3px;animation-delay:0.9s;"></span>
  </div>
  <svg class="ghibli-moon" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
    <ellipse cx="32" cy="32" rx="22" ry="22" fill="#fffbe7"/>
    <ellipse cx="38" cy="32" rx="18" ry="18" fill="#23202a"/>
  </svg>
  <svg class="ghibli-fingerprint" viewBox="0 0 90 90" fill="none" xmlns="http://www.w3.org/2000/svg">
    <ellipse cx="45" cy="45" rx="36" ry="36" stroke="#fffbe7" stroke-width="2.5"/>
    <path d="M30 60 Q45 70 60 60" stroke="#fffbe7" stroke-width="2" fill="none"/>
    <path d="M35 50 Q45 60 55 50" stroke="#fffbe7" stroke-width="1.5" fill="none"/>
    <path d="M40 40 Q45 50 50 40" stroke="#fffbe7" stroke-width="1.2" fill="none"/>
  </svg>
  <div style="position:fixed;top:32px;left:38px;z-index:100;user-select:none;">
    <div id="gameTitleBadge" style="display:inline-block;padding:14px 32px 10px 32px;background:linear-gradient(120deg,#23202a 60%,#6b5a3a 100%);border-radius:14px 10px 18px 10px/10px 18px 10px 18px;border:2px solid #7bb0e6;box-shadow:0 2px 18px 0 #23202a99,0 2px 0 #7bb0e644 inset;position:relative;overflow:hidden;min-width:100px;filter:blur(0.1px);transition:all 0.3s;">
      <span id="gameTitleText" style="position:relative;z-index:2;font-size:1.45rem;color:#e2c391;font-family:'Caveat','Segoe Print','Comic Sans MS',cursive;font-style:italic;font-weight:600;text-shadow:0 1px 0 #23202a,0 2px 6px #7bb0e644,0 0 8px #23202a99;letter-spacing:1.1px;text-align:center;text-wrap:nowrap;display:block;filter:blur(0.1px);transition:all 0.3s;">who's cheating?</span>
      <span id="gameTitleConfetti" style="position:absolute;left:0;top:0;width:100%;height:100%;z-index:1;pointer-events:none;opacity:0.13;background:repeating-linear-gradient(135deg,#7bb0e6 0 2px,transparent 2px 8px);"></span>
    </div>
  </div>
  <button id="toggleStageBtn" style="position:fixed;top:32px;right:38px;z-index:200;padding:10px 22px;font-size:1.08rem;font-family:'Caveat','Segoe Print','Comic Sans MS',cursive;background:linear-gradient(120deg,#fffbe7 60%,#e2c391 100%);color:#7a5a2f;border:2px solid #e2c391;border-radius:12px 18px 12px 18px/18px 12px 18px 12px;box-shadow:0 2px 8px 0 #e2c39133;cursor:pointer;transition:all 0.2s;">Switch to Day</button>
  <svg class="ghibli-sun" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
    <circle cx="32" cy="32" r="22" fill="#ffe7b2"/>
    <circle cx="32" cy="32" r="16" fill="#fffbe7"/>
  </svg>
  <div class="circle-table-container">
    <div class="circle-table">
      <div class="table-items">
        <div class="plate-stack"></div>
        <div class="glasses">
          <div class="glass"></div>
          <div class="glass"></div>
          <div class="glass"></div>
        </div>
        <div class="napkin">
          <div class="chopsticks"></div>
        </div>
      </div>
      <div class="role-cards-circle" id="roleCardsCircle"></div>
    </div>
  </div>
  <div class="floating-hearts">
    <div class="broken-heart" style="left:12vw; bottom:0; width:38px; animation-delay:0s;">
      <svg viewBox="0 0 32 32" width="38" height="38">
        <path d="M16 29s-7.5-6.2-10.5-10.2C2.1 16.2 1 13.7 1 11.3 1 6.7 4.7 3 9.3 3c2.2 0 4.2 1.1 5.5 2.8C16.5 4.1 18.5 3 20.7 3 25.3 3 29 6.7 29 11.3c0 2.4-1.1 4.9-4.5 7.5C23.5 19.8 16 29 16 29z" fill="#b94a4a"/>
        <path d="M16 29s-2.5-3.2-4.5-6.2c2.5-2.7 4.5-5.8 4.5-9.8l-2.5 2.5 2.5-7.5 2.5 7.5-2.5-2.5c0 4 2 7.1 4.5 9.8C18.5 25.8 16 29 16 29z" fill="#fffbe7" opacity=".5"/>
        <polyline points="16,10 13,15 17,19 15,24" fill="none" stroke="#23202a" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
        <ellipse cx="17.5" cy="25.5" rx="1.1" ry="2.2" fill="#7bb0e6" opacity=".7"/>
      </svg>
    </div>
    <div class="flower" style="left:18vw; bottom:0; width:32px; animation-delay:0.7s;">
      <svg viewBox="0 0 32 32" width="32" height="32">
        <circle cx="16" cy="16" r="7" fill="#ffe7b2"/>
        <ellipse cx="16" cy="7" rx="3.5" ry="7" fill="#f7b2b7"/>
        <ellipse cx="16" cy="25" rx="3.5" ry="7" fill="#f7b2b7"/>
        <ellipse cx="7" cy="16" rx="7" ry="3.5" fill="#f7ecd7"/>
        <ellipse cx="25" cy="16" rx="7" ry="3.5" fill="#f7ecd7"/>
        <circle cx="16" cy="16" r="2.2" fill="#e2c391"/>
      </svg>
    </div>
    <div class="flower" style="left:38vw; bottom:-40px; width:24px; animation-delay:2.2s;">
      <svg viewBox="0 0 32 32" width="24" height="24">
        <circle cx="16" cy="16" r="7" fill="#ffe7b2"/>
        <ellipse cx="16" cy="7" rx="3.5" ry="7" fill="#b2e7d7"/>
        <ellipse cx="16" cy="25" rx="3.5" ry="7" fill="#b2e7d7"/>
        <ellipse cx="7" cy="16" rx="7" ry="3.5" fill="#f7ecd7"/>
        <ellipse cx="25" cy="16" rx="7" ry="3.5" fill="#f7ecd7"/>
        <circle cx="16" cy="16" r="2.2" fill="#e2c391"/>
      </svg>
    </div>
    <div class="flower" style="left:65vw; bottom:-60px; width:36px; animation-delay:4.5s;">
      <svg viewBox="0 0 32 32" width="36" height="36">
        <circle cx="16" cy="16" r="7" fill="#ffe7b2"/>
        <ellipse cx="16" cy="7" rx="3.5" ry="7" fill="#f7ecd7"/>
        <ellipse cx="16" cy="25" rx="3.5" ry="7" fill="#f7ecd7"/>
        <ellipse cx="7" cy="16" rx="7" ry="3.5" fill="#f7b2b7"/>
        <ellipse cx="25" cy="16" rx="7" ry="3.5" fill="#f7b2b7"/>
        <circle cx="16" cy="16" r="2.2" fill="#e2c391"/>
      </svg>
    </div>
    <div class="flower" style="left:80vw; bottom:-30px; width:28px; animation-delay:7.5s;">
      <svg viewBox="0 0 32 32" width="28" height="28">
        <circle cx="16" cy="16" r="7" fill="#ffe7b2"/>
        <ellipse cx="16" cy="7" rx="3.5" ry="7" fill="#b2e7d7"/>
        <ellipse cx="16" cy="25" rx="3.5" ry="7" fill="#b2e7d7"/>
        <ellipse cx="7" cy="16" rx="7" ry="3.5" fill="#f7b2b7"/>
        <ellipse cx="25" cy="16" rx="7" ry="3.5" fill="#f7b2b7"/>
        <circle cx="16" cy="16" r="2.2" fill="#e2c391"/>
      </svg>
    </div>
  </div>
  <div class="confetti">
    <span style="position:absolute;left:10vw;top:8vh;width:8px;height:8px;background:#ffdca8;border-radius:50%;opacity:0.7;"></span>
    <span style="position:absolute;left:22vw;top:12vh;width:6px;height:6px;background:#f7b2b7;border-radius:50%;opacity:0.7;"></span>
    <span style="position:absolute;left:40vw;top:6vh;width:7px;height:7px;background:#b2e7d7;border-radius:50%;opacity:0.7;"></span>
    <span style="position:absolute;left:60vw;top:10vh;width:8px;height:8px;background:#ffe7b2;border-radius:50%;opacity:0.7;"></span>
    <span style="position:absolute;left:80vw;top:14vh;width:6px;height:6px;background:#e2c391;border-radius:50%;opacity:0.7;"></span>
  </div>
  <div class="game-rule-summary" id="gameRuleSummary" style="top: 160px;">
    <div class="rule-title">How to Play</div>
    <div class="how-to-play">
      <div class="role-section"><b>Game Overview</b></div>
      <ul style="margin:0 0 0 12px;padding:0 0 0 0;list-style:disc;">
        <li>6–9 players: Cheaters vs. Keepers</li>
        <li>Cheaters: 2–3 players, Keepers: 4–6 players</li>
        <li>Each player gets a unique role with special abilities</li>
        <li>Game ends when all Cheaters are caught or when Cheaters win</li>
      </ul>

      <div class="role-section"><b>Game Flow</b></div>
      <ul style="margin:0 0 0 12px;padding:0 0 0 0;list-style:disc;">
        <li>Each round, players take turns picking Helpers</li>
        <li>Helpers can be Love (positive) or Hate (negative)</li>
        <li>Keepers try to identify Cheaters through Helper choices</li>
        <li>Cheaters try to blend in while achieving their goals</li>
      </ul>

      <div class="role-section"><b>Scoring System</b></div>
      <ul style="margin:0 0 0 12px;padding:0 0 0 0;list-style:disc;">
        <li>Scandal Score: Tracks Cheaters' progress</li>
        <li>Close-Knot Score: Tracks Keepers' progress</li>
        <li>Party Count: Number of rounds played</li>
      </ul>

      <div class="role-section"><b>Role Abilities</b></div>
      <div class="role-description">
        <div><b>Michael</b> (Cheater): Can instantly win by correctly guessing Abby's identity. Use this ability wisely as it's a one-time opportunity!</div>
        <div><b>Wind</b> (Cheater): Adds 2 to the Scandal Score and can flip any Helper from Love to Hate. Perfect for creating chaos!</div>
        <div><b>Jack</b> (Cheater): Remains hidden from Abby and other Cheaters. Use this to your advantage to coordinate secretly.</div>
        <div><b>Abby</b> (Keeper): Can see all Cheaters except Jack. Your main detective - use their information wisely!</div>
        <div><b>Kennedi</b> (Keeper): All Helpers count as Love for them. A powerful ability to counter negative effects.</div>
        <div><b>Ker</b> (Keeper): Can swap one Helper after it's been picked. Use this to protect against harmful choices.</div>
        <div><b>Pets</b>: Regular players with no special abilities, but can still contribute to the team's success!</div>
      </div>

      <div class="role-section"><b>Tips for Success</b></div>
      <ul style="margin:0 0 0 12px;padding:0 0 0 0;list-style:disc;">
        <li>Cheaters: Coordinate secretly and create confusion</li>
        <li>Keepers: Share information and watch for suspicious patterns</li>
        <li>Pay attention to Helper choices and player reactions</li>
        <li>Use special abilities at the right moment</li>
        <li>Remember: Bluffing and deception are key elements of the game!</li>
      </ul>
    </div>
  </div>
  <div id="gameStateBox" style="position:fixed;left:38px;top:70%;transform:translateY(-50%);z-index:200;background:rgba(255,251,231,0.93);border-radius:18px;padding:18px 22px 14px 22px;box-shadow:0 2px 18px 0 #e2c39133,0 2px 0 #fffbe7 inset;font-size:1.08rem;min-width:220px;max-width:340px;line-height:1.5;border:2px solid #e2c391;display:none;"></div>
  <div id="gameActionBox" style="position:fixed;left:38px;bottom:38px;z-index:210;background:rgba(255,251,231,0.97);border-radius:18px;padding:18px 22px 14px 22px;box-shadow:0 2px 18px 0 #e2c39133,0 2px 0 #fffbe7 inset;font-size:1.08rem;min-width:220px;max-width:420px;line-height:1.5;border:2px solid #e2c391;display:none;text-align:center;"></div>
  <div id="candidateHostBox" style="position:fixed;top:60px;right:38px;left:auto;transform:none;z-index:210;background:rgba(255,251,231,0.97);border-radius:16px;padding:12px 32px 10px 32px;box-shadow:0 2px 12px 0 #e2c39133,0 2px 0 #fffbe7 inset;font-size:1.18rem;min-width:160px;max-width:320px;line-height:1.5;border:2px solid #e2c391;text-align:center;font-family:'Caveat','Segoe Print','Comic Sans MS',cursive;display:none;font-weight:bold;color:#7a5a2f;"></div>
  <div class="game-container">
    <h1 class="game-title">Who's Cheating?</h1>
    
    <div class="game-stats-box">
      <div class="stat-item">
        <div class="stat-label">Party Count</div>
        <div style="display:flex;align-items:center;justify-content:center;gap:6px;">
          <button class="stat-btn" onclick="changeStat('partyCount',-1)">-1</button>
          <div class="stat-value" id="partyCount">0</div>
          <button class="stat-btn" onclick="changeStat('partyCount',1)">+1</button>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Scandal Score</div>
        <div style="display:flex;align-items:center;justify-content:center;gap:6px;">
          <button class="stat-btn" onclick="changeStat('scandalScore',-1)">-1</button>
          <div class="stat-value" id="scandalScore">0</div>
          <button class="stat-btn" onclick="changeStat('scandalScore',1)">+1</button>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Close-Knot Score</div>
        <div style="display:flex;align-items:center;justify-content:center;gap:6px;">
          <button class="stat-btn" onclick="changeStat('closeKnotScore',-1)">-1</button>
          <div class="stat-value" id="closeKnotScore">0</div>
          <button class="stat-btn" onclick="changeStat('closeKnotScore',1)">+1</button>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Vote Count</div>
        <div style="display:flex;align-items:center;justify-content:center;gap:6px;">
          <button class="stat-btn" onclick="changeStat('voteCount',-1)">-1</button>
          <div class="stat-value" id="voteCount">0</div>
          <button class="stat-btn" onclick="changeStat('voteCount',1)">+1</button>
        </div>
      </div>
    </div>
    <div class="love-hate-box" style="display: flex; flex-direction: row; align-items: center; justify-content: space-between;">
      <div style="flex:1;">
        <div class="stat-item">
          <div class="stat-label">Love Count</div>
          <div class="stat-value" id="loveCount">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Hate Count</div>
          <div class="stat-value" id="hateCount">0</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:12px;">
        <button id="takeActionBtn" class="stat-btn" style="min-width:110px;height:60px;font-size:1.13em;align-self:center;">Take Action</button>
        <button id="resetCountBtn" class="stat-btn" style="min-width:130px;height:54px;font-size:1.08em;align-self:center;">Reset Count</button>
        <button id="resetVoteBtn" class="stat-btn" style="min-width:130px;height:54px;font-size:1.08em;align-self:center;">Reset Vote</button>
      </div>
    </div>
    <button id="resetBtn" class="stat-btn" style="min-width:170px;height:54px;font-size:1.13em;align-self:center;position:fixed;right:60px;bottom:38px;z-index:121;">Restart the Game</button>
    <div id="skillButtonContainer" style="position:fixed;display:flex;flex-direction:column;gap:12px;"></div>

    <div class="game-status-box">
  </div>
  <button id="testStartBtn" style="position:fixed;left:38px;bottom:38px;z-index:300;padding:14px 38px;font-size:1.15rem;font-family:inherit;background:linear-gradient(100deg,#e2c391 80%,#f7e7c6 100%);color:#5a4327;border:3px solid #bfa16a;border-radius:18px 40px 18px 40px / 40px 18px 40px 18px;box-shadow:4px 8px 24px 0 rgba(90,67,39,0.18),0 2.5px 0 #e2c391 inset,0 0 0 8px #e2c39122 inset;cursor:pointer;transition:box-shadow 0.2s,transform 0.18s,background 0.2s,border 0.2s;display:none;" disabled>Start</button>
  <button id="finishTalkingBtn" style="display:none;position:fixed;z-index:300;padding:12px 28px;font-size:1.08rem;font-family:inherit;background:linear-gradient(100deg,#e2c391 80%,#f7e7c6 100%);color:#5a4327;border:2.5px solid #bfa16a;border-radius:16px 32px 16px 32px / 32px 16px 32px 16px;box-shadow:2px 4px 12px 0 rgba(90,67,39,0.13),0 1.5px 0 #e2c391 inset,0 0 0 4px #e2c39122 inset;cursor:pointer;transition:box-shadow 0.18s,transform 0.15s,background 0.18s,border 0.18s;">Finish Talking</button>
  <button id="muteBtn" style="display:none;position:fixed;z-index:300;padding:12px 28px;font-size:1.08rem;font-family:inherit;background:linear-gradient(100deg,#e2c391 80%,#f7e7c6 100%);color:#5a4327;border:2.5px solid #bfa16a;border-radius:16px 32px 16px 32px / 32px 16px 32px 16px;box-shadow:2px 4px 12px 0 rgba(90,67,39,0.13),0 1.5px 0 #e2c391 inset,0 0 0 4px #e2c39122 inset;cursor:pointer;transition:box-shadow 0.18s,transform 0.15s,background 0.18s,border 0.18s;">Mute</button>
  <button id="voteYesBtn" style="display:none;position:fixed;z-index:300;padding:12px 28px;font-size:1.08rem;font-family:inherit;background:linear-gradient(100deg,#b2e7d7 80%,#7bb0e6 100%);color:#2c3e50;border:2.5px solid #7bb0e6;border-radius:16px 32px 16px 32px / 32px 16px 32px 16px;box-shadow:2px 4px 12px 0 rgba(90,67,39,0.13),0 1.5px 0 #7bb0e6 inset,0 0 0 4px #7bb0e622 inset;cursor:pointer;transition:box-shadow 0.18s,transform 0.15s,background 0.18s,border 0.18s;margin-top:8px;margin-right:8px;">❤️ Love</button>
  <button id="voteNoBtn" style="display:none;position:fixed;z-index:300;padding:12px 28px;font-size:1.08rem;font-family:inherit;background:linear-gradient(100deg,#f7b2b7 80%,#e2c391 100%);color:#2c3e50;border:2.5px solid #e2c391;border-radius:16px 32px 16px 32px / 32px 16px 32px 16px;box-shadow:2px 4px 12px 0 rgba(90,67,39,0.13),0 1.5px 0 #e2c391 inset,0 0 0 4px #e2c39122 inset;cursor:pointer;transition:box-shadow 0.18s,transform 0.15s,background 0.18s,border 0.18s;margin-top:8px;">💔 Hate</button>
  <button id="voteSubmitBtn" style="display:none;position:fixed;z-index:300;padding:12px 28px;font-size:1.08rem;font-family:inherit;background:linear-gradient(100deg,#7bb0e6 80%,#b2e7d7 100%);color:#fff;border:2.5px solid #3498db;border-radius:16px 32px 16px 32px / 32px 16px 32px 16px;box-shadow:2px 4px 12px 0 rgba(52,152,219,0.13),0 1.5px 0 #7bb0e6 inset,0 0 0 4px #7bb0e622 inset;cursor:pointer;transition:box-shadow 0.18s,transform 0.15s,background 0.18s,border 0.18s;margin-top:8px;margin-left:8px;">Vote</button>
  <script>
    // --- Night/Day Mode Helper ---
    function setNightMode(on) {
      const body = document.body;
      const titleBadge = document.getElementById('gameTitleBadge');
      const titleText = document.getElementById('gameTitleText');
      const toggleBtn = document.getElementById('toggleStageBtn');
      if (on) {
        body.classList.remove('day-stage');
        // Night mode title
        titleBadge.style.background = 'linear-gradient(120deg,#23202a 60%,#6b5a3a 100%)';
        titleBadge.style.borderColor = '#7bb0e6';
        titleText.textContent = "who's cheating?";
        titleText.style.color = '#e2c391';
        titleText.style.fontStyle = 'italic';
        titleText.style.fontWeight = '600';
        titleText.style.textShadow = '0 1px 0 #23202a,0 2px 6px #7bb0e644,0 0 8px #23202a99';
        titleText.style.fontSize = '1.45rem';
        // Night mode toggle button
        toggleBtn.textContent = '🌞 Switch to Day';
        toggleBtn.style.background = 'linear-gradient(120deg,#23202a 60%,#22304a 100%)';
        toggleBtn.style.color = '#7bb0e6';
        toggleBtn.style.border = '2px solid #7bb0e6';
        toggleBtn.style.boxShadow = '0 2px 8px 0 #23202a99';
        toggleBtn.style.transition = 'all 0.2s';
        rerenderSkillButtons();
        updateVoteButtonsUsability();
        enableLoveHateStatButtons();
      } else {
        body.classList.add('day-stage');
        // Day mode title
        titleBadge.style.background = 'linear-gradient(120deg,#ffe7b2 60%,#e2c391 100%)';
        titleBadge.style.borderColor = '#e2c391';
        titleText.textContent = 'Family Party';
        titleText.style.color = '#e2a84f';
        titleText.style.fontStyle = 'normal';
        titleText.style.fontWeight = 'bold';
        titleText.style.textShadow = '0 1px 0 #fffbe7,0 2px 6px #e2c39144';
        titleText.style.fontSize = '1.45rem';
        // Day mode toggle button
        toggleBtn.textContent = '🌙 Switch to Night';
        toggleBtn.style.background = 'linear-gradient(120deg,#ffe7b2 60%,#e2c391 100%)';
        toggleBtn.style.color = '#7a5a2f';
        toggleBtn.style.border = '2px solid #e2c391';
        toggleBtn.style.boxShadow = '0 2px 8px 0 #e2c39133';
        toggleBtn.style.transition = 'all 0.2s';
        rerenderSkillButtons();
        updateVoteButtonsUsability();
        enableLoveHateStatButtons();
      }
      console.log('Body classList:', body.classList.toString());
    }
    // --- Game Role Logic ---
    const roleImages = {
      michael: 'imgs/michael.png',
      wind: 'imgs/wind.png',
      abby: 'imgs/abby.png',
      kennedi: 'imgs/kennedi.png',
      kiko: 'imgs/kiko.png',
      knox: 'imgs/knox.png',
    };
    const backsideImg = 'imgs/backSide.png';
    const playerNames = ['Totoro', 'Kiki', 'Chihiro', 'Howl', 'Satsuki', 'Pazu'];
    const roles = ['michael','wind','abby','kennedi','kiko','knox'];
    // Shuffle roles
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
    const shuffledRoles = shuffle([...roles]);
    // Assign "You" a random role
    const myIndex = 0;
    const myRole = shuffledRoles[myIndex];
    // --- Render Role Cards Around Table ---
    function renderRoleCards() {
      const container = document.getElementById('roleCardsCircle');
      container.innerHTML = '';
      const n = playerNames.length;
      const radius = 250;
      // Role info for tooltip
      const roleInfo = {
        michael: {name:'Michael', team:'Cheater', power:'Guess Abby for instant win'},
        wind: {name:'Wind', team:'Cheater', power:'Molest: +2 Scandal at night; Mislead: flip Love→Hate'},
        abby: {name:'Abby', team:'Keeper', power:'Sees all Cheaters except Jack'},
        kennedi: {name:'Kennedi', team:'Keeper', power:'Protect: all cards count as Love'},
        kiko: {name:'Kiko', team:'Keeper (Pet)', power:'No special power'},
        knox: {name:'Knox', team:'Keeper (Pet)', power:'No special power'},
        nash: {name:'Nash', team:'Keeper (Pet)', power:'No special power'},
        jack: {name:'Jack', team:'Cheater', power:'Hidden from Abby & Cheaters'},
        ker: {name:'Ker', team:'Keeper', power:'Swap a Helper after picked'},
      };
      // Only if myRole is Abby, show all cards face-up
      const showAllCards = myRole === 'abby';
      playerNames.forEach((name, i) => {
        // Place 'You' at the bottom (angle = Math.PI/2)
        const angle = (2 * Math.PI * i) / n + Math.PI / 2;
        const x = radius * Math.cos(angle);
        const y = radius * Math.sin(angle);
        const card = document.createElement('img');
        card.className = 'role-card' + (i === myIndex ? ' me' : '');
        card.style.left = `calc(50% + ${x}px - 55px)`;
        card.style.top = `calc(50% + ${y}px - 80px)`;
        // If myRole is Abby, show all cards face-up
        if (showAllCards) {
          card.src = roleImages[shuffledRoles[i]] || backsideImg;
          card.alt = shuffledRoles[i];
        } else {
          card.src = i === myIndex ? roleImages[myRole] : backsideImg;
          card.alt = i === myIndex ? myRole : 'Hidden';
        }
        container.appendChild(card);
        // Add role intro tooltip for myself only
        if (i === myIndex) {
          const tooltip = document.createElement('div');
          tooltip.className = 'role-intro-tooltip';
          const info = roleInfo[myRole];
          tooltip.innerHTML = `<div class='role-title'>${info.name} (${info.team})</div><div><b>Power:</b> ${info.power}</div>`;
          card.addEventListener('mouseenter',()=>{tooltip.classList.add('active');});
          card.addEventListener('mouseleave',()=>{tooltip.classList.remove('active');});
          container.appendChild(tooltip);
        }
        // Add player name label
        const nameLabel = document.createElement('div');
        nameLabel.className = 'player-name-label';
        // Always put the name above the card if the card is at the bottom (y > 0), otherwise below
        const nameOffsetY = y > 0 ? 120 : -120;
        nameLabel.style.left = `calc(50% + ${x}px)`;
        nameLabel.style.top = `calc(50% + ${y + nameOffsetY}px)`;
        nameLabel.textContent = name;
        container.appendChild(nameLabel);
      });
    }
    renderRoleCards();
    // Toggle between day and night stage
    const btn = document.getElementById('toggleStageBtn');
    const body = document.body;
    let isDay = false;
    btn.onclick = function() {
      isDay = !isDay;
      setNightMode(isDay);
    };
    function renderSkillButtons() {
      const container = document.getElementById('skillButtonContainer');
      // No skill button for Jack, Abby, or pets
      const petRoles = ['kiko', 'knox', 'nash'];
      if (myRole === 'jack' || myRole === 'abby' || petRoles.includes(myRole)) {
        container.style.display = 'none';
        container.innerHTML = '';
        return;
      }
      // Find my card position first
      const myCard = document.querySelector('.role-card.me');
      if (myCard) {
        const rect = myCard.getBoundingClientRect();
        // Move skill buttons to the left/below the card
        container.style.position = 'fixed';
        container.style.left = (rect.left - 240) + 'px';
        container.style.top = (rect.top + rect.height + 8) + 'px';
      }
      if (myRole === 'wind') {
        container.style.display = 'flex';
        container.style.flexDirection = 'row';
        container.innerHTML = '';
        const btn1 = document.createElement('button');
        btn1.textContent = 'Molest';
        btn1.className = 'skill-btn';
        // Only enabled if not used and night mode
        const isNight = !document.body.classList.contains('day-stage');
        btn1.disabled = gameState.windMolestUsed || !isNight;
        btn1.style.opacity = (gameState.windMolestUsed || !isNight) ? '0.5' : '1';
        btn1.onclick = () => {
          if (gameState.windMolestUsed || !isNight) return;
          gameState.windMolestUsed = true;
          let scandalEl = document.getElementById('scandalScore');
          let val = parseInt(scandalEl.textContent, 10) || 0;
          val += 2;
          scandalEl.textContent = val;
          btn1.disabled = true;
          btn1.style.opacity = '0.5';
        };
        const btn2 = document.createElement('button');
        btn2.textContent = 'Mislead';
        btn2.className = 'skill-btn';
        btn2.onclick = () => alert('Wind: Mislead skill used!');
        container.appendChild(btn1);
        container.appendChild(btn2);
      } else {
        container.style.display = 'flex';
        container.style.flexDirection = 'column';
        container.innerHTML = '';
        const rolePowers = {
          michael: 'Finding Abby',
          kennedi: 'Protecting the Party',
          ker: 'The Chosen One',
        };
        const btn = document.createElement('button');
        btn.textContent = rolePowers[myRole] || 'Use Skill';
        btn.className = 'skill-btn';
        btn.onclick = () => alert('Skill used!');
        container.appendChild(btn);
      }
      // In renderSkillButtons, add logic for Michael's skill button
      if (myRole === 'michael') {
        container.style.display = 'flex';
        container.style.flexDirection = 'column';
        container.innerHTML = '';
        const btn = document.createElement('button');
        btn.textContent = 'Finding Abby';
        btn.className = 'skill-btn';
        btn.disabled = !!gameState.michaelFindingAbbyUsed;
        btn.style.opacity = btn.disabled ? '0.5' : '1';
        btn.onclick = () => {
          if (gameState.michaelFindingAbbyUsed) return;
          gameState.michaelFindingAbbyUsed = true;
          btn.disabled = true;
          btn.style.opacity = '0.5';
          showStatus("Michael thinks he has found Abby!");
        };
        container.appendChild(btn);
      }
    }
    // Call after rendering cards to ensure position is correct
    renderRoleCards();
    // Add a helper to always enable stat adjustment buttons in love-hate-box
    function enableLoveHateStatButtons() {
      document.querySelectorAll('.love-hate-box .stat-btn').forEach(btn => {
        btn.disabled = false;
        btn.classList.remove('disabled');
        btn.style.opacity = '1';
      });
    }
    // Call this after rerenderSkillButtons, setNightMode, and DOMContentLoaded
    function rerenderSkillButtons() {
      setTimeout(() => {
        renderSkillButtons();
        enableLoveHateStatButtons();
        setPowerSkillButtonsEnabled(false);
        attachSkillButtonHandlers();
      }, 150);
    }
    rerenderSkillButtons();
    window.addEventListener('resize', rerenderSkillButtons);
    // Add test Start button logic
    document.getElementById('testStartBtn').onclick = function() {
      window.location.reload();
    };



    function updateStatsUI() {
      document.getElementById('partyCount').textContent = gameState.partyCount;
      document.getElementById('scandalScore').textContent = gameState.scandalScore;
      document.getElementById('closeKnotScore').textContent = gameState.closeKnotScore;
    }

    // Add a helper to get the current phase label
    function getPhaseLabel() {
      switch (gameState.phase) {
        case 'night': return '🌙 Night Phase';
        case 'speech': return '🗣️ Speech Stage';
        case 'voting': return '🗳️ Voting Stage';
        case 'host-election': return '👑 Host Election';
        case 'drama': return '🎭 Drama Play';
        case 'reveal': return '🔍 Reveal';
        case 'end': return '🏁 Game Over';
        default: return '';
      }
    }

    // Update showStatus to always show the phase label
    function showStatus(msg) {
      let box = document.getElementById('gameStateBox');
      box.style.display = 'block';
      const phaseLabel = getPhaseLabel();
      box.innerHTML = (phaseLabel ? `<div style='font-weight:bold;font-size:1.13em;margin-bottom:6px;'>${phaseLabel}</div>` : '') + `<div style='font-weight:bold;color:#3498db;'>${msg}</div>`;
    }

    function hideStartButton() {
      document.getElementById('testStartBtn').style.display = 'none';
    }

    function showCandidateHost() {
      const box = document.getElementById('candidateHostBox');
      if (gameState.candidateHost !== null) {
        box.style.display = 'block';
        box.textContent = `Candidate Host: ${gameState.candidateHost}`;
      } else {
        box.style.display = 'none';
      }
    }

    function startGame() {
      hideStartButton();
      // Randomly assign candidate host
      const randIdx = Math.floor(Math.random() * playerNames.length);
      gameState.candidateHost = playerNames[randIdx];
      showCandidateHost();
      gameState.partyCount = 0;
      gameState.scandalScore = 0;
      gameState.closeKnotScore = 0;
      gameState.phase = 'night';
      gameState.round = 1;
      gameState.hostIndex = 0;
      gameState.helpers = [];
      gameState.usedSkills = {};
      gameState.gameEnded = false;
      updateStatsUI();
      showStatus('<b>Game Started!</b><br>Night phase begins.');
      setTimeout(nightPhase, 2000);
    }

    function nightPhase() {
      if (gameState.gameEnded) return;
      setNightMode(true); // Always set to night mode at the start of night phase
      gameState.phase = 'night';
      showStatus('Night phase: <b>10 seconds</b>... Wind may use <b>Molest</b> (Scandal +2, once per game).');
      // Enable Wind's Molest button if it's Wind and not used
      if (myRole === 'wind' && !gameState.windMolestUsed) {
        enableWindMolestButton();
      }
      // 10 second timer
      gameState.nightTimer = setTimeout(() => {
        // If Wind didn't use Molest, default Scandal +1
        if (!gameState.windMolestUsed) {
          gameState.scandalScore += 1;
          showStatus('Night phase ended: Scandal +1.');
        }
        updateStatsUI();
        disableWindMolestButton();
        setNightMode(false); // Always set to day mode after night phase ends
        setTimeout(hostElectionPhase, 2000);
      }, 10000);
    }

    function enableWindMolestButton() {
      const container = document.getElementById('skillButtonContainer');
      const btns = container.querySelectorAll('.skill-btn');
      btns.forEach(btn => {
        if (btn.textContent === 'Molest') {
          btn.disabled = false;
          btn.style.opacity = '1';
          btn.onclick = () => {
            if (gameState.phase !== 'night' || gameState.windMolestUsed) return;
            gameState.windMolestUsed = true;
            gameState.scandalScore += 2;
            showStatus('Wind used <b>Molest</b>! Scandal +2.');
            updateStatsUI();
            btn.disabled = true;
            btn.style.opacity = '0.5';
            // End night phase early if used
            clearTimeout(gameState.nightTimer);
            setTimeout(hostElectionPhase, 2000);
          };
        }
      });
    }
    function disableWindMolestButton() {
      const container = document.getElementById('skillButtonContainer');
      const btns = container.querySelectorAll('.skill-btn');
      btns.forEach(btn => {
        if (btn.textContent === 'Molest') {
          btn.disabled = true;
          btn.style.opacity = '0.5';
        }
      });
    }

    function hostElectionPhase() {
      if (gameState.gameEnded) return;
      setNightMode(false); // Always set to day mode at the start of non-night phases
      gameState.phase = 'host-election';
      // Pass candidate host to the next player clockwise
      if (gameState.candidateHost !== null) {
        let idx = playerNames.indexOf(gameState.candidateHost);
        gameState.candidateHost = playerNames[(idx + 1) % playerNames.length];
      }
      // Show candidate host UI
      showCandidateHost();
      showStatus(`<b>Host Election</b>: ${gameState.candidateHost} is the candidate host.`);
      setTimeout(() => helperSelectionPhase(gameState.candidateHost), 2000);
    }

    function helperSelectionPhase(host) {
      if (gameState.gameEnded) return;
      setNightMode(false);
      // For now, pick next 2 players as helpers
      let h1 = playerNames[(gameState.hostIndex + 1) % playerNames.length];
      let h2 = playerNames[(gameState.hostIndex + 2) % playerNames.length];
      gameState.helpers = [h1, h2];
      showStatus(`<b>${host}</b> picks helpers: <b>${h1}</b> and <b>${h2}</b>.`);
      setTimeout(skillUsePhase, 2000);
    }

    function skillUsePhase() {
      if (gameState.gameEnded) return;
      setNightMode(false);
      // For now, just show a message
      showStatus('Skill use window: eligible players may use skills.');
      setTimeout(dramaPlayPhase, 2000);
    }

    function dramaPlayPhase() {
      if (gameState.gameEnded) return;
      setNightMode(false);
      gameState.phase = 'drama';
      // For now, randomize Love/Hate
      let loveCount = Math.floor(Math.random() * 3) + 1;
      let hateCount = 3 - loveCount;
      // Party count increases only when entering family party (drama play)
      gameState.partyCount++;
      updateStatsUI();
      showStatus(`Drama cards played: <b>${loveCount} Love</b>, <b>${hateCount} Hate</b>.`);
      setTimeout(() => revealPhase(loveCount, hateCount), 2000);
    }

    function revealPhase(loveCount, hateCount) {
      if (gameState.gameEnded) return;
      setNightMode(false);
      gameState.phase = 'reveal';
      // Update scores
      gameState.closeKnotScore += loveCount;
      gameState.scandalScore += hateCount;
      updateStatsUI();
      showStatus(`Reveal: Close-Knot +${loveCount}, Scandal +${hateCount}.`);
      setTimeout(endgameCheckPhase, 2000);
    }

    function endgameCheckPhase() {
      if (gameState.gameEnded) return;
      setNightMode(false);
      // End conditions
      if (gameState.partyCount >= gameState.maxParties || gameState.scandalScore >= gameState.maxScandal) {
        gameState.gameEnded = true;
        gameState.phase = 'end';
        let winner = (gameState.closeKnotScore > gameState.scandalScore) ? 'Keepers' : 'Cheaters';
        showStatus(`<b>Game Over!</b><br>Winner: <b>${winner}</b><br>Close-Knot: ${gameState.closeKnotScore}, Scandal: ${gameState.scandalScore}`);
        return;
      }
      // Next round
      gameState.hostIndex++;
      setTimeout(nightPhase, 2000);
    }

    function positionFinishTalkingBtn() {
      const btn = document.getElementById('finishTalkingBtn');
      const muteBtn = document.getElementById('muteBtn');
      const yesBtn = document.getElementById('voteYesBtn');
      const noBtn = document.getElementById('voteNoBtn');
      const submitBtn = document.getElementById('voteSubmitBtn');
      const myCard = document.querySelector('.role-card.me');
      if (myCard) {
        const rect = myCard.getBoundingClientRect();
        btn.style.display = 'block';
        btn.style.left = (rect.right + 18) + 'px';
        btn.style.top = (rect.top + rect.height / 2 + 16) + 'px';
        // Position mute button to the right of finish talking button
        muteBtn.style.display = 'block';
        muteBtn.style.left = (rect.right + 220) + 'px';
        muteBtn.style.top = (rect.top + rect.height / 2 + 16) + 'px';
        // Position Love and Hate buttons directly under Finish Talking button
        yesBtn.style.display = 'block';
        noBtn.style.display = 'block';
        submitBtn.style.display = 'block';
        yesBtn.style.left = btn.style.left;
        yesBtn.style.top = (parseFloat(btn.style.top) + btn.offsetHeight + 18) + 'px';
        noBtn.style.left = (parseFloat(btn.style.left) + 102) + 'px';
        noBtn.style.top = (parseFloat(btn.style.top) + btn.offsetHeight + 18) + 'px';
        submitBtn.style.left = (parseFloat(btn.style.left) + 204) + 'px';
        submitBtn.style.top = (parseFloat(btn.style.top) + btn.offsetHeight + 18) + 'px';
      } else {
        btn.style.display = 'none';
        muteBtn.style.display = 'none';
        yesBtn.style.display = 'none';
        noBtn.style.display = 'none';
        submitBtn.style.display = 'none';
      }
    }
    // Show and position the button after cards are rendered
    setTimeout(positionFinishTalkingBtn, 300);
    window.addEventListener('resize', positionFinishTalkingBtn);
    // Optionally, add a click handler
    document.getElementById('finishTalkingBtn').onclick = function() {
      if (this.disabled || playerNames[0] !== speechOrder[currentSpeakerIdx]) return;
      this.disabled = true;
      this.classList.add('disabled');
      this.style.opacity = '0.5';
      currentSpeakerIdx++;
      if (currentSpeakerIdx < speechOrder.length) {
        updateSpeechUI();
        showStatus(`<b>Speech Stage</b>: ${speechOrder[currentSpeakerIdx]}'s turn to speak.`);
        if (playerNames[0] !== speechOrder[currentSpeakerIdx]) {
          setTimeout(simulateOtherSpeech, 1200);
        }
      } else {
        // Speech done, start voting
        startVotingStage();
      }
    };

    // --- Microphone System ---
    let micStream = null;
    let isMuted = true;
    const muteBtn = document.getElementById('muteBtn');
    muteBtn.onclick = async function() {
      if (isMuted) {
        // Try to get mic access
        try {
          micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          isMuted = false;
          muteBtn.textContent = 'Unmute';
          muteBtn.style.background = 'linear-gradient(100deg,#b2e7d7 80%,#7bb0e6 100%)';
        } catch (e) {
          alert('Microphone access denied or unavailable.');
        }
      } else {
        // Stop all tracks
        if (micStream) {
          micStream.getTracks().forEach(track => track.stop());
        }
        isMuted = true;
        muteBtn.textContent = 'Mute';
        muteBtn.style.background = 'linear-gradient(100deg,#e2c391 80%,#f7e7c6 100%)';
      }
    };

    // --- Speech and Voting Logic ---
    let speechOrder = [];
    let currentSpeakerIdx = 0;
    let votingStage = false;
    let votes = {};
    let votingTimer = null;

    function startSpeechStage() {
      // Build speech order starting from candidate host
      const startIdx = playerNames.indexOf(gameState.candidateHost);
      speechOrder = [];
      for (let i = 0; i < playerNames.length; i++) {
        speechOrder.push(playerNames[(startIdx + i) % playerNames.length]);
      }
      currentSpeakerIdx = 0;
      votingStage = false;
      gameState.phase = 'speech';
      updateSpeechUI();
      showStatus(`<b>Speech Stage</b>: ${speechOrder[currentSpeakerIdx]}'s turn to speak.`);
      // If not my turn, simulate other player's speech
      if (playerNames[0] !== speechOrder[currentSpeakerIdx]) {
        setTimeout(simulateOtherSpeech, 1200);
      } else {
        // It's the user's turn, ensure the Finish Talking button is enabled and visible
        const btn = document.getElementById('finishTalkingBtn');
        btn.disabled = false;
        btn.classList.remove('disabled');
        btn.style.opacity = '1';
      }
    }

    function simulateOtherSpeech() {
      currentSpeakerIdx++;
      if (currentSpeakerIdx < speechOrder.length) {
        updateSpeechUI();
        showStatus(`<b>Speech Stage</b>: ${speechOrder[currentSpeakerIdx]}'s turn to speak.`);
        if (playerNames[0] !== speechOrder[currentSpeakerIdx]) {
          setTimeout(simulateOtherSpeech, 1200);
        }
        // If it's your turn, pause and wait for your action
      } else {
        // Speech done, start voting
        startVotingStage();
      }
    }

    function updateSpeechUI() {
      const btn = document.getElementById('finishTalkingBtn');
      if (playerNames[0] === speechOrder[currentSpeakerIdx]) {
        btn.disabled = false;
        btn.classList.remove('disabled');
        btn.style.opacity = '1';
      } else {
        btn.disabled = true;
        btn.classList.add('disabled');
        btn.style.opacity = '0.5';
      }
    }

    function startVotingStage() {
      votingStage = true;
      votes = {};
      gameState.phase = 'voting';
      showVoteButtons(true);
      showStatus('<b>Voting Stage</b>: Vote Yes or No for the candidate host!');
      // 10 sec timer for voting
      votingTimer = setTimeout(() => {
        if (!votes[playerNames[0]]) {
          votes[playerNames[0]] = 'no';
        }
        finishVotingStage();
      }, 10000);
    }

    function showVoteButtons(show) {
      const yesBtn = document.getElementById('voteYesBtn');
      const noBtn = document.getElementById('voteNoBtn');
      const myCard = document.querySelector('.role-card.me');
      if (show) {
        yesBtn.style.display = 'block';
        noBtn.style.display = 'block';
        if (myCard) {
          const rect = myCard.getBoundingClientRect();
          yesBtn.style.left = (rect.right + 18) + 'px';
          yesBtn.style.top = (rect.top + rect.height / 2 + 70) + 'px';
          noBtn.style.left = (rect.right + 120) + 'px';
          noBtn.style.top = (rect.top + rect.height / 2 + 70) + 'px';
        }
        yesBtn.disabled = false;
        yesBtn.classList.remove('disabled');
        yesBtn.style.opacity = '1';
        noBtn.disabled = false;
        noBtn.classList.remove('disabled');
        noBtn.style.opacity = '1';
      } else {
        yesBtn.style.display = 'none';
        noBtn.style.display = 'none';
      }
    }

    // Update Love, Vote, and Hate button logic to only be usable in day mode
    function updateVoteButtonsUsability() {
      const isDay = document.body.classList.contains('day-stage');
      const loveBtn = document.getElementById('voteYesBtn');
      const hateBtn = document.getElementById('voteNoBtn');
      const voteBtn = document.getElementById('voteSubmitBtn');
      loveBtn.disabled = !isDay;
      hateBtn.disabled = !isDay;
      voteBtn.disabled = !isDay;
      loveBtn.style.opacity = !isDay ? '0.5' : '1';
      hateBtn.style.opacity = !isDay ? '0.5' : '1';
      voteBtn.style.opacity = !isDay ? '0.5' : '1';
    }

    // Remove background mode logic for enabling/disabling Love/Hate buttons
    function setLoveHateButtonsEnabled(enabled) {
      const loveBtn = document.getElementById('voteYesBtn');
      const hateBtn = document.getElementById('voteNoBtn');
      const voteSubmitBtn = document.getElementById('voteSubmitBtn');
      loveBtn.disabled = !enabled;
      hateBtn.disabled = !enabled;
      voteSubmitBtn.disabled = !enabled;
      loveBtn.style.opacity = enabled ? '1' : '0.5';
      hateBtn.style.opacity = enabled ? '1' : '0.5';
      voteSubmitBtn.style.opacity = enabled ? '1' : '0.5';
    }
    // Initially disable Love/Hate buttons
    setLoveHateButtonsEnabled(false);
    document.getElementById('takeActionBtn').onclick = function() {
      // Show message overlay for Take Action
      const overlay = document.getElementById('takeActionMessageOverlay');
      overlay.style.display = 'block';
      setTimeout(() => {
        overlay.style.display = 'none';
        setLoveHateButtonsEnabled(true);
      }, 5000);
    };
    document.getElementById('resetCountBtn').onclick = function() {
      document.getElementById('loveCount').textContent = 0;
      document.getElementById('hateCount').textContent = 0;
    };
    document.getElementById('resetVoteBtn').onclick = function() {
      setLoveHateButtonsEnabled(true);
    };
    const voteSubmitBtn = document.getElementById('voteSubmitBtn');
    voteSubmitBtn.onclick = function() {
      if (this.disabled) return;
      let voteEl = document.getElementById('voteCount');
      let voteVal = parseInt(voteEl.textContent, 10) || 0;
      voteEl.textContent = voteVal + 1;
      setLoveHateButtonsEnabled(false);
      // Show message overlay
      const overlay = document.getElementById('powerMessageOverlay');
      overlay.style.display = 'block';
      setPowerSkillButtonsEnabled(true);
      setTimeout(() => {
        overlay.style.display = 'none';
        setPowerSkillButtonsEnabled(false);
      }, 10000);
    };
    // Remove or comment out any calls to updateVoteButtonsUsability that affect Love/Hate buttons
    // ... existing code ...
  </script>
  <!-- At the end of the script, after all UI is rendered, always show and enable the Yes/No buttons -->
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      const yesBtn = document.getElementById('voteYesBtn');
      const noBtn = document.getElementById('voteNoBtn');
      yesBtn.style.display = 'block';
      noBtn.style.display = 'block';
      yesBtn.disabled = true;
      noBtn.disabled = true;
      yesBtn.style.opacity = '0.5';
      noBtn.style.opacity = '0.5';
    });
  </script>
  <script>
    function changeStat(statId, delta) {
      const el = document.getElementById(statId);
      let val = parseInt(el.textContent, 10) || 0;
      val += delta;
      if (val < 0) val = 0;
      el.textContent = val;
    }
  </script>
  <script>
    document.getElementById('resetBtn').onclick = function() {
      window.location.reload();
    };
  </script>
  <script>
    // Attach click handlers for +1 logic, only increment if enabled
    const loveBtn = document.getElementById('voteYesBtn');
    loveBtn.onclick = function() {
      if (this.disabled) return;
      pendingAction = 'love';
      setLoveHateButtonsEnabled(false);
      // Show message overlay and enable skills for 10s
      const overlay = document.getElementById('powerMessageOverlay');
      overlay.style.display = 'block';
      setPowerSkillButtonsEnabled(true);
      setTimeout(() => {
        overlay.style.display = 'none';
        setPowerSkillButtonsEnabled(false);
        processPendingAction();
      }, 10000);
    };
    const hateBtn = document.getElementById('voteNoBtn');
    hateBtn.onclick = function() {
      if (this.disabled) return;
      pendingAction = 'hate';
      setLoveHateButtonsEnabled(false);
      // Show message overlay and enable skills for 10s
      const overlay = document.getElementById('powerMessageOverlay');
      overlay.style.display = 'block';
      setPowerSkillButtonsEnabled(true);
      setTimeout(() => {
        overlay.style.display = 'none';
        setPowerSkillButtonsEnabled(false);
        processPendingAction();
      }, 10000);
    };
    const voteBtn = document.getElementById('voteBtn');
    voteBtn.onclick = function() {
      if (this.disabled) return;
      let voteEl = document.getElementById('voteCount');
      let voteVal = parseInt(voteEl.textContent, 10) || 0;
      voteEl.textContent = voteVal + 1;
      setLoveHateButtonsEnabled(false);
    };
  </script>
  <!-- Add a message overlay div to the body -->
  <div id="powerMessageOverlay" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9999;background:rgba(255,251,231,0.98);border-radius:18px;padding:32px 48px 28px 48px;box-shadow:0 2px 32px 0 #e2c39177,0 2px 0 #fffbe7 inset;font-size:1.45rem;font-family:'Caveat','Segoe Print','Comic Sans MS',cursive;color:#7a5a2f;font-weight:bold;text-align:center;pointer-events:none;">Wind and Kennedi are allowed to the power now!</div>
  <!-- Add a message overlay div for Take Action if not already present -->
  <div id="takeActionMessageOverlay" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9999;background:rgba(255,251,231,0.98);border-radius:18px;padding:32px 48px 28px 48px;box-shadow:0 2px 32px 0 #e2c39177,0 2px 0 #fffbe7 inset;font-size:1.45rem;font-family:'Caveat','Segoe Print','Comic Sans MS',cursive;color:#7a5a2f;font-weight:bold;text-align:center;pointer-events:none;">Host and helpers can take your love or hate action now!</div>
  <script>
    // Utility to enable/disable Wind's Mislead and Kennedi's Protect the Party skill buttons
    function setPowerSkillButtonsEnabled(enabled) {
      // Wind's Mislead
      const misleadBtn = Array.from(document.querySelectorAll('.skill-btn')).find(btn => btn.textContent.trim().toLowerCase().includes('mislead'));
      if (misleadBtn) {
        misleadBtn.disabled = !enabled;
        misleadBtn.style.opacity = enabled ? '1' : '0.5';
      }
      // Kennedi's Protect the Party
      const protectBtn = Array.from(document.querySelectorAll('.skill-btn')).find(btn => btn.textContent.trim().toLowerCase().includes('protect'));
      if (protectBtn) {
        protectBtn.disabled = !enabled;
        protectBtn.style.opacity = enabled ? '1' : '0.5';
      }
    }
  </script>
  <script>
    // On page load and after rerenderSkillButtons, always disable these skill buttons by default
    window.addEventListener('DOMContentLoaded', function() {
      setPowerSkillButtonsEnabled(false);
      attachSkillButtonHandlers();
    });
  </script>


  <script>
    // Add global variables to track pending action and skill usage
    let pendingAction = null;
    let kennediProtectUsed = false;
    let windMisleadUsed = false;
  </script>

  <script>
    // Add a function to process the pending action after 10s
    function processPendingAction() {
      if (!pendingAction) return;
      // Kennedi's skill takes absolute precedence
      if (kennediProtectUsed) {
        let loveEl = document.getElementById('loveCount');
        let loveVal = parseInt(loveEl.textContent, 10) || 0;
        loveEl.textContent = loveVal + 1;
      } else if (windMisleadUsed && pendingAction === 'love') {
        // Wind's Mislead always flips 1 Love to 1 Hate
        let hateEl = document.getElementById('hateCount');
        let hateVal = parseInt(hateEl.textContent, 10) || 0;
        hateEl.textContent = hateVal + 1;
      } else if (pendingAction === 'love') {
        let loveEl = document.getElementById('loveCount');
        let loveVal = parseInt(loveEl.textContent, 10) || 0;
        loveEl.textContent = loveVal + 1;
      } else if (pendingAction === 'hate') {
        let hateEl = document.getElementById('hateCount');
        let hateVal = parseInt(hateEl.textContent, 10) || 0;
        hateEl.textContent = hateVal + 1;
      }
      // Reset for next round
      pendingAction = null;
      kennediProtectUsed = false;
      windMisleadUsed = false;
    }
  </script>
  <script>
    // Place this logic after renderSkillButtons or rerenderSkillButtons, and only attach handlers if not already attached
    function attachSkillButtonHandlers() {
      // Wind's Mislead
      const misleadBtn = Array.from(document.querySelectorAll('.skill-btn')).find(btn => btn.textContent.trim().toLowerCase().includes('mislead'));
      if (misleadBtn && !misleadBtn._handlerAttached) {
        misleadBtn.onclick = function() {
          if (this.disabled) return;
          windMisleadUsed = true;
          this.disabled = true;
          this.style.opacity = '0.5';
          // Removed message overlay for Mislead
        };
        misleadBtn._handlerAttached = true;
      }
      // Kennedi's Protect the Party
      const protectBtn = Array.from(document.querySelectorAll('.skill-btn')).find(btn => btn.textContent.trim().toLowerCase().includes('protect'));
      if (protectBtn && !protectBtn._handlerAttached) {
        protectBtn.onclick = function() {
          if (this.disabled) return;
          kennediProtectUsed = true;
          this.disabled = true;
          this.style.opacity = '0.5';
          // Removed message overlay for Protecting the Party
        };
        protectBtn._handlerAttached = true;
      }
    }
    // Call attachSkillButtonHandlers after rerenderSkillButtons and on DOMContentLoaded
    window.addEventListener('DOMContentLoaded', function() {
      setPowerSkillButtonsEnabled(false);
      attachSkillButtonHandlers();
    });
    function rerenderSkillButtons() {
      setTimeout(() => {
        renderSkillButtons();
        enableLoveHateStatButtons();
        setPowerSkillButtonsEnabled(false);
        attachSkillButtonHandlers();
      }, 150);
    }
  </script>
  <!-- Add Socket.IO client -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
  // Multiplayer setup
  const socket = io();
  const urlParams = new URLSearchParams(window.location.search);
  const myName = urlParams.get('name');
  const roomId = urlParams.get('room');

  // Join the game room
  socket.emit('joinGame', { playerName: myName, roomId });

  // Listen for game state updates from the server
  let gameState = {};
  socket.on('gameState', (state) => {
    gameState = state;
    updateUIFromState();
  });

  // Emit actions to the server
  function onVote(vote) {
    socket.emit('playerVote', { vote, roomId });
  }
  function onUseSkill(skill) {
    socket.emit('playerSkill', { skill, roomId });
  }

  // UI update function (to be implemented based on your UI structure)
  function updateUIFromState() {
    // Example: update stats
    document.getElementById('partyCount').textContent = gameState.partyCount || 0;
    document.getElementById('scandalScore').textContent = gameState.scandalScore || 0;
    document.getElementById('closeKnotScore').textContent = gameState.closeKnotScore || 0;
    document.getElementById('loveCount').textContent = gameState.loveCount || 0;
    document.getElementById('hateCount').textContent = gameState.hateCount || 0;
    document.getElementById('voteCount').textContent = gameState.voteCount || 0;
    // TODO: update player list, roles, skill buttons, etc. from gameState
  }

  // Replace all button click handlers to emit events
  const loveBtn = document.getElementById('voteYesBtn');
  loveBtn.onclick = function() {
    if (this.disabled) return;
    onVote('love');
  };
  const hateBtn = document.getElementById('voteNoBtn');
  hateBtn.onclick = function() {
    if (this.disabled) return;
    onVote('hate');
  };
  const voteSubmitBtn = document.getElementById('voteSubmitBtn');
  voteSubmitBtn.onclick = function() {
    if (this.disabled) return;
    onVote('vote');
  };
  // Example for skill button (you may need to update selector/logic)
  function attachSkillButtonHandlers() {
    const misleadBtn = Array.from(document.querySelectorAll('.skill-btn')).find(btn => btn.textContent.trim().toLowerCase().includes('mislead'));
    if (misleadBtn && !misleadBtn._handlerAttached) {
      misleadBtn.onclick = function() {
        if (this.disabled) return;
        onUseSkill('mislead');
      };
      misleadBtn._handlerAttached = true;
    }
    const protectBtn = Array.from(document.querySelectorAll('.skill-btn')).find(btn => btn.textContent.trim().toLowerCase().includes('protect'));
    if (protectBtn && !protectBtn._handlerAttached) {
      protectBtn.onclick = function() {
        if (this.disabled) return;
        onUseSkill('protect');
      };
      protectBtn._handlerAttached = true;
    }
  }
  window.addEventListener('DOMContentLoaded', function() {
    attachSkillButtonHandlers();
  });
  // Remove all local simulation, random votes, and local-only state changes
  // All game logic and state updates should now come from the server
  </script>
</body>
</html>
